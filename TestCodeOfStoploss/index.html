<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precision Trading Calculator with Live Prices</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- EmailJS SDK for real email sending -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Add FileSaver.js for file downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Add docx library for Word document generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2962ff;
            --primary-dark: #0039cb;
            --secondary: #ff6d00;
            --success: #00c853;
            --danger: #ff1744;
            --warning: #ffab00;
            --dark: #121212;
            --dark-card: #1e1e1e;
            --dark-text: #f5f5f5;
            --light: #f5f7fa;
            --light-card: #ffffff;
            --light-text: #263238;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a237e, #311b92);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 450px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .login-logo i {
            font-size: 40px;
            color: var(--secondary);
        }

        .login-title {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #666;
            font-size: 16px;
            font-weight: 500;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .login-input-group {
            position: relative;
        }

        .login-input {
            width: 100%;
            padding: 18px 50px 18px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            background: rgba(245, 247, 250, 0.8);
            transition: all 0.3s ease;
            color: var(--light-text);
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(41, 98, 255, 0.1);
            background: white;
        }

        .login-input-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 18px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .login-input:focus+.login-input-icon {
            color: var(--primary);
        }

        .password-toggle {
            cursor: pointer;
            user-select: none;
        }

        .password-toggle:hover {
            color: var(--primary);
        }

        .login-button {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(41, 98, 255, 0.4);
        }

        .login-button:active {
            transform: translateY(0);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            background: rgba(255, 23, 68, 0.1);
            border: 1px solid rgba(255, 23, 68, 0.3);
            color: var(--danger);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
            color: var(--success);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            display: none;
        }

        .login-features {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e0e0e0;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }

        .feature-icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        /* Signup Form Styles */
        .signup-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: #444;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-input {
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(41, 98, 255, 0.1);
        }

        .password-requirements {
            margin-top: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .password-requirements h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #444;
        }

        .password-requirements ul {
            padding-left: 20px;
        }

        .password-requirements li {
            margin-bottom: 5px;
            font-size: 13px;
            color: #666;
        }

        .requirement-not-met {
            color: #dc3545;
        }

        .requirement-met {
            color: #28a745;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e0e0e0;
        }

        .divider span {
            padding: 0 15px;
        }

        .login-links {
            display: flex;
            justify-content: center;
        }

        .login-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        /* EmailJS Configuration Styles */
        .emailjs-section {
            background: rgba(41, 98, 255, 0.05);
            border: 1px solid rgba(41, 98, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .emailjs-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .emailjs-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-switch.active::before {
            transform: translateX(26px);
        }

        .emailjs-content {
            display: none;
        }

        .emailjs-content.active {
            display: block;
        }

        .emailjs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .emailjs-info {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .emailjs-info a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .emailjs-info a:hover {
            text-decoration: underline;
        }

        /* Main Dashboard Styles */
        .main-dashboard {
            display: none;
        }

        .main-dashboard.active {
            display: block;
        }

        body {
            background: linear-gradient(135deg, #1a237e, #311b92);
            color: var(--light-text);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.4s ease;
        }

        body.dark {
            background: linear-gradient(135deg, #0d1b2a, #1b263b);
            color: var(--dark-text);
        }

        /* Header with user info */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark .header {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar-container {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-avatar-container:hover {
            transform: scale(1.05);
        }

        .user-avatar-container:hover .avatar-edit-icon {
            opacity: 1;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        .avatar-edit-icon {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
        }

        .user-details h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--light-text);
        }

        body.dark .user-details h3 {
            color: var(--dark-text);
        }

        .user-details p {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #d50000;
            transform: translateY(-2px);
        }

        .dashboard-container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .currency-converter-sidebar {
                order: -1;
                position: static;
                height: auto;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .currency-converter-sidebar {
                position: static;
                height: auto;
                order: 2;
                margin-top: 20px;
            }

            .main-content {
                order: 1;
            }

            body {
                padding: 10px;
            }

            .card {
                padding: 20px;
            }

            .main-tabs {
                flex-direction: column;
                gap: 5px;
            }

            .main-tab {
                padding: 10px 15px;
                font-size: 14px;
            }

            .row {
                flex-direction: column;
                gap: 10px;
            }

            .position-toggle {
                flex-direction: column;
                gap: 10px;
            }

            .btn-group {
                flex-direction: column;
                gap: 10px;
            }

            .history-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .history-table {
                min-width: 800px;
                font-size: 11px;
            }

            .history-table th,
            .history-table td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .outcome-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .win-loss-container {
                flex-direction: column;
                gap: 10px;
            }

            .date-filter {
                flex-wrap: wrap;
                gap: 8px;
            }

            .date-filter-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .custom-date-input {
                padding: 6px 10px;
                font-size: 12px;
            }

            .notes-actions {
                flex-direction: column;
                gap: 10px;
            }

            .history-actions {
                flex-direction: column;
                gap: 10px;
            }

            .currency-select {
                flex-direction: column;
                gap: 10px;
            }

            .currency-select i {
                transform: rotate(90deg);
                align-self: center;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
                max-width: none;
                width: calc(100% - 40px);
            }

            .avatar-modal-content {
                margin: 20px;
                padding: 20px;
                max-width: none;
                width: calc(100% - 40px);
            }

            .avatar-options {
                justify-content: center;
                gap: 10px;
            }

            .avatar-option {
                width: 80px;
                height: 80px;
                margin: 5px;
            }

            .login-card {
                margin: 10px;
                padding: 30px 20px;
                max-width: none;
                width: calc(100% - 20px);
            }

            .login-title {
                font-size: 24px;
            }

            .login-subtitle {
                font-size: 14px;
            }

            .feature-item {
                font-size: 13px;
            }

            .feature-icon {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            .emailjs-grid {
                grid-template-columns: 1fr;
            }
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .card {
            background: var(--light-card);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        body.dark .card {
            background: var(--dark-card);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        body.dark .card-header {
            border-bottom: 1px solid #333;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--light-text);
        }

        body.dark .card-title {
            color: var(--dark-text);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        body.dark .toggle-switch {
            background: #555;
        }

        body.dark .toggle-switch::before {
            transform: translateX(26px);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--light-text);
        }

        body.dark .input-label {
            color: var(--dark-text);
        }

        .input-field {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(245, 247, 250, 0.8);
            transition: all 0.3s;
            color: var(--light-text);
        }

        body.dark .input-field {
            background: #2a2a2a;
            border-color: #444;
            color: var(--dark-text);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.2);
        }

        .slider-container {
            margin-top: 5px;
        }

        .slider {
            width: 100%;
            height: 6px;
            appearance: none;
            -webkit-appearance: none;
            background: #e0e0e0;
            border-radius: 3px;
            outline: none;
        }

        body.dark .slider {
            background: #444;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--primary-dark);
        }

        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .row>div {
            flex: 1;
        }

        .position-toggle {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .position-btn {
            flex: 1;
            padding: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            background: #f0f4ff;
            color: var(--primary);
        }

        body.dark .position-btn {
            background: #2a2a2a;
        }

        .position-btn.active {
            background: var(--primary);
            color: white;
        }

        .position-btn.short.active {
            background: var(--danger);
        }

        .result-container {
            background: linear-gradient(135deg, #2962ff, #0039cb);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        body.dark .result-container {
            background: linear-gradient(135deg, #1e3a8a, #0d2b6b);
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 14px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .result-value {
            font-size: 24px;
            font-weight: 700;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f4ff;
            color: var(--primary);
        }

        body.dark .btn-secondary {
            background: #2a2a2a;
            color: var(--dark-text);
        }

        .btn-secondary:hover {
            background: #e0e8ff;
            transform: translateY(-2px);
        }

        body.dark .btn-secondary:hover {
            background: #333;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #009624;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #d50000;
            transform: translateY(-2px);
        }

        .main-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(245, 247, 250, 0.8);
            border-radius: 12px;
            padding: 5px;
            flex-wrap: wrap;
        }

        body.dark .main-tabs {
            background: rgba(42, 42, 42, 0.8);
        }

        .main-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--light-text);
            min-width: 120px;
        }

        body.dark .main-tab {
            color: var(--dark-text);
        }

        .main-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 10px rgba(41, 98, 255, 0.3);
        }

        .main-tab:hover:not(.active) {
            background: rgba(41, 98, 255, 0.1);
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #f0f4ff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            color: var(--light-text);
        }

        body.dark .tab {
            background: #2a2a2a;
            color: var(--dark-text);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .profit-loss-container {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        body.dark .profit-loss-container {
            background: linear-gradient(135deg, #2e7d32, #1b5e20);
        }

        /* Trading Fees Container */
        .trading-fees-container {
            background: linear-gradient(135deg, #ff6d00, #e65100);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 109, 0, 0.3);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        body.dark .trading-fees-container {
            background: linear-gradient(135deg, #e65100, #d84315);
        }

        /* INR Display */
        .inr-value {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
            font-weight: 600;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .history-table th,
        .history-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        body.dark .history-table th,
        body.dark .history-table td {
            border-bottom: 1px solid #444;
        }

        .history-table th {
            background: rgba(41, 98, 255, 0.1);
            font-weight: 600;
            font-size: 11px;
            color: var(--light-text);
        }

        body.dark .history-table th {
            background: rgba(41, 98, 255, 0.2);
            color: var(--dark-text);
        }

        .history-table tr:hover {
            background: rgba(41, 98, 255, 0.05);
        }

        body.dark .history-table tr:hover {
            background: rgba(41, 98, 255, 0.1);
        }

        .profit {
            color: var(--success);
        }

        .loss {
            color: var(--danger);
        }

        .history-table-container {
            overflow-x: auto;
            max-width: 100%;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .logo h1 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .logo-icon {
            font-size: 40px;
            color: var(--secondary);
        }

        .calculator-icon {
            font-size: 24px;
            color: var(--primary);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .info-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 20px;
            height: 20px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Currency Converter Sidebar */
        .currency-converter-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        @media (max-width: 1200px) {
            .currency-converter-sidebar {
                position: static;
                height: auto;
            }
        }

        .currency-select {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .currency-select select {
            flex: 1;
            padding: 14px 15px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: rgba(245, 247, 250, 0.8);
            color: var(--light-text);
        }

        body.dark .currency-select select {
            background: #2a2a2a;
            border-color: #444;
            color: var(--dark-text);
        }

        .conversion-result {
            background: linear-gradient(135deg, #00c853, #009624);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-top: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
            display: none;
        }

        body.dark .conversion-result {
            background: linear-gradient(135deg, #006400, #004d00);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--light-card);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        body.dark .modal-content {
            background: var(--dark-card);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal-body {
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .outcome-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .outcome-btn {
            flex: 1;
            padding: 15px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            opacity: 0.6;
        }

        .outcome-btn.selected {
            opacity: 1;
            transform: scale(1.05);
        }

        .outcome-btn.win {
            background: var(--success);
            color: white;
        }

        .outcome-btn.loss {
            background: var(--danger);
            color: white;
        }

        .outcome-btn.pending {
            background: var(--warning);
            color: white;
        }

        .outcome-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
        }

        .outcome-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            margin-right: 5px;
            font-size: 10px;
        }

        .outcome-win {
            background: var(--success);
            color: white;
        }

        .outcome-loss {
            background: var(--danger);
            color: white;
        }

        .outcome-pending {
            background: var(--warning);
            color: white;
        }

        .mark-outcome-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            background: var(--warning);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mark-outcome-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* Fee Selection Styles */
        .fee-selection {
            margin: 20px 0;
            padding: 20px;
            background: rgba(41, 98, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(41, 98, 255, 0.1);
        }

        body.dark .fee-selection {
            background: rgba(41, 98, 255, 0.1);
            border-color: rgba(41, 98, 255, 0.2);
        }

        .fee-selection h4 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
        }

        .fee-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .fee-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--light-text);
        }

        body.dark .fee-btn {
            border-color: #444;
            color: var(--dark-text);
        }

        .fee-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .fee-btn.maker.selected {
            border-color: #2196f3;
            background: #2196f3;
        }

        .fee-btn.taker.selected {
            border-color: var(--secondary);
            background: var(--secondary);
        }

        .fee-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .fee-comparison-item {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }

        .fee-comparison-item.maker {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .fee-comparison-item.taker {
            background: rgba(255, 109, 0, 0.1);
            border: 1px solid rgba(255, 109, 0, 0.3);
        }

        .fee-comparison-label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .fee-comparison-value {
            font-size: 16px;
            font-weight: 700;
        }

        /* Enhanced Notification Styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            opacity: 0;
            transform: translateX(100%) scale(0.8);
            border: 2px solid transparent;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0) scale(1);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success), #2e7d32);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger), #d32f2f);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .notification i {
            margin-right: 12px;
            font-size: 18px;
        }

        .notification-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notification-text {
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin-left: 15px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        /* Enhanced Alert Notification */
        .alert-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(255, 171, 0, 0.4);
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: alertSlideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                alertPulse 2s infinite,
                alertFadeOut 0.5s 9.5s forwards;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            max-width: 450px;
        }

        .alert-notification .bell-icon {
            font-size: 24px;
            animation: bellRing 0.5s ease-in-out 3;
        }

        .alert-notification-content {
            flex: 1;
        }

        .alert-notification-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .alert-notification-details {
            font-size: 14px;
            opacity: 0.9;
        }

        .alert-notification-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .alert-notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        @keyframes alertSlideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }

            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes alertPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        @keyframes alertFadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes bellRing {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(15deg);
            }
        }

        /* Email Modal Styles */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .email-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .email-modal-content {
            background: var(--light-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .email-modal.show .email-modal-content {
            transform: scale(1);
        }

        body.dark .email-modal-content {
            background: var(--dark-card);
        }

        .email-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .email-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .email-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .email-body {
            background: rgba(41, 98, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(41, 98, 255, 0.1);
        }

        body.dark .email-body {
            background: rgba(41, 98, 255, 0.1);
            border-color: rgba(41, 98, 255, 0.2);
        }

        .email-field {
            margin-bottom: 15px;
        }

        .email-field-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 14px;
        }

        .email-field-value {
            color: var(--light-text);
            font-size: 16px;
        }

        body.dark .email-field-value {
            color: var(--dark-text);
        }

        .email-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            line-height: 1.6;
        }

        body.dark .email-content {
            background: #2a2a2a;
            border-color: #444;
        }

        .email-footer {
            display: flex;
            justify-content: center;
        }

        .email-close-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .email-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(41, 98, 255, 0.3);
        }

        /* API Status Indicators */
        .api-status-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .api-status-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--light-text);
        }

        body.dark .api-status-title {
            color: var(--dark-text);
        }

        .api-status-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .api-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 14px;
            font-weight: 500;
        }

        .api-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .api-status-indicator.online {
            background: var(--success);
        }

        .api-status-indicator.offline {
            background: var(--danger);
        }

        .api-status-indicator.checking {
            background: var(--warning);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Enhanced Alert Item Styles */
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 15px;
            margin-bottom: 15px;
            background: rgba(245, 247, 250, 0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        body.dark .alert-item {
            background: rgba(42, 42, 42, 0.5);
            border-color: #444;
        }

        .alert-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .alert-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .alert-item.triggered::before {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .alert-info {
            flex: 1;
        }

        .alert-symbol {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .alert-condition {
            font-size: 14px;
            color: #888;
            margin-bottom: 5px;
        }

        .alert-current-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .alert-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--light-text);
            margin-right: 15px;
        }

        body.dark .alert-price {
            color: var(--dark-text);
        }

        .alert-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 15px;
        }

        .alert-active {
            background: rgba(0, 200, 83, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 200, 83, 0.3);
        }

        .alert-triggered {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
            border: 1px solid rgba(255, 193, 7, 0.3);
            animation: pulse 1s infinite;
        }

        .alert-actions {
            display: flex;
            gap: 8px;
        }

        /* Performance Analytics */
        .total-pl-container {
            background: linear-gradient(135deg, #2962ff, #0039cb);
            border-radius: 15px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.3);
            text-align: center;
        }

        body.dark .total-pl-container {
            background: linear-gradient(135deg, #1e3a8a, #0d2b6b);
        }

        .total-pl-label {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .total-pl-value {
            font-size: 36px;
            font-weight: 700;
        }

        .total-pl-value.positive {
            color: #4caf50;
        }

        .total-pl-value.negative {
            color: #f44336;
        }

        .section-title {
            font-size: 18px;
            margin: 20px 0 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--light-text);
        }

        body.dark .section-title {
            border-bottom: 1px solid #444;
            color: var(--dark-text);
        }

        .edit-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: #e68900;
            transform: translateY(-1px);
        }

        .chart-container {
            height: 200px;
            margin-top: 20px;
        }

        .win-loss-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .win-counter {
            flex: 1;
            background: rgba(76, 175, 80, 0.15);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .loss-counter {
            flex: 1;
            background: rgba(244, 67, 54, 0.15);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .win-loss-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--light-text);
        }

        body.dark .win-loss-label {
            color: var(--dark-text);
        }

        .win-loss-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--light-text);
        }

        body.dark .win-loss-value {
            color: var(--dark-text);
        }

        .editable-field {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 5px 8px;
            color: inherit;
            font-size: inherit;
            width: 100%;
        }

        body.dark .editable-field {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.2);
        }

        .decimal-info {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
            text-align: right;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .delete-btn i {
            margin-right: 3px;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Avatar Upload Modal */
        .avatar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .avatar-modal-content {
            background: var(--light-card);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            text-align: center;
        }

        body.dark .avatar-modal-content {
            background: var(--dark-card);
        }

        .avatar-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .avatar-options {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .avatar-option {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 10px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(41, 98, 255, 0.3);
        }

        .upload-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f7fa;
            border: 2px dashed #ccc;
        }

        body.dark .upload-option {
            background: #2a2a2a;
            border-color: #444;
        }

        .upload-icon {
            font-size: 30px;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 20px auto;
            background-size: cover;
            background-position: center;
            border: 2px solid var(--border);
            display: none;
        }

        .file-input-container {
            position: relative;
            margin: 20px 0;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 20px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .file-input-label:hover {
            background: var(--primary-dark);
        }

        .avatar-modal-footer {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* Portfolio Tracker Styles */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .portfolio-summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 25px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .portfolio-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .portfolio-change {
            font-size: 18px;
            font-weight: 600;
        }

        .portfolio-change.positive {
            color: #4caf50;
        }

        .portfolio-change.negative {
            color: #f44336;
        }

        .asset-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .asset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: all 0.3s;
        }

        body.dark .asset-item {
            border-bottom-color: #444;
        }

        .asset-item:hover {
            background: rgba(41, 98, 255, 0.05);
        }

        .asset-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .asset-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--light-text);
        }

        body.dark .asset-details h4 {
            color: var(--dark-text);
        }

        .asset-details p {
            margin: 2px 0 0 0;
            font-size: 12px;
            color: #888;
        }

        .asset-values {
            text-align: right;
        }

        .asset-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--light-text);
        }

        body.dark .asset-value {
            color: var(--dark-text);
        }

        .asset-change {
            font-size: 14px;
            font-weight: 600;
        }

        .asset-change.positive {
            color: var(--success);
        }

        .asset-change.negative {
            color: var(--danger);
        }

        /* Trade Journal Styles */
        .journal-entry {
            background: rgba(41, 98, 255, 0.05);
            border: 1px solid rgba(41, 98, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        body.dark .journal-entry {
            background: rgba(41, 98, 255, 0.1);
            border-color: rgba(41, 98, 255, 0.2);
        }

        .journal-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(41, 98, 255, 0.2);
        }

        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .journal-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #888;
        }

        .screenshot-container {
            margin: 15px 0;
            text-align: center;
        }

        .screenshot-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .screenshot-preview:hover {
            transform: scale(1.02);
        }

        .screenshot-upload {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(245, 247, 250, 0.5);
        }

        body.dark .screenshot-upload {
            background: rgba(42, 42, 42, 0.5);
            border-color: #444;
        }

        .screenshot-upload:hover {
            border-color: var(--primary);
            background: rgba(41, 98, 255, 0.05);
        }

        .screenshot-upload i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Risk Management Styles */
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .risk-metric {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        body.dark .risk-metric {
            background: rgba(30, 30, 30, 0.8);
        }

        .risk-metric:hover {
            transform: translateY(-5px);
        }

        .risk-metric-icon {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .risk-metric-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--light-text);
        }

        body.dark .risk-metric-value {
            color: var(--dark-text);
        }

        .risk-metric-label {
            font-size: 14px;
            color: #888;
            font-weight: 600;
        }

        .risk-warning {
            background: rgba(255, 23, 68, 0.1);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: var(--danger);
            font-weight: 600;
        }

        .risk-safe {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: var(--success);
            font-weight: 600;
        }

        /* Advanced Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        body.dark .analytics-card {
            background: rgba(30, 30, 30, 0.8);
        }

        .analytics-card:hover {
            transform: translateY(-5px);
        }

        .analytics-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .analytics-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--light-text);
        }

        body.dark .analytics-value {
            color: var(--dark-text);
        }

        .analytics-change {
            font-size: 14px;
            font-weight: 600;
            margin-top: 5px;
        }

        .analytics-change.positive {
            color: var(--success);
        }

        .analytics-change.negative {
            color: var(--danger);
        }

        /* Responsive adjustments for new features */
        @media (max-width: 768px) {
            .portfolio-grid {
                grid-template-columns: 1fr;
            }

            .risk-metrics {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .fee-comparison {
                grid-template-columns: 1fr;
            }

            .fee-buttons {
                flex-direction: column;
            }

            .alert-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .alert-actions {
                margin-left: 0;
            }

            .api-status-list {
                justify-content: center;
            }

            .alert-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                padding: 15px 20px;
            }

            .email-modal-content {
                margin: 10px;
                padding: 20px;
                max-width: none;
                width: calc(100% - 20px);
            }
        }

        /* Live Price Styles */
        .live-price-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(41, 98, 255, 0.1);
            border-radius: 10px;
        }

        .live-price-label {
            font-weight: 600;
            color: var(--primary);
        }

        .live-price-value {
            font-weight: 700;
            font-size: 18px;
        }

        .price-history-chart {
            height: 100px;
            margin-top: 15px;
        }

        .price-change-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .price-up {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .price-down {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }

        .symbol-input-container {
            display: flex;
            gap: 10px;
        }

        .symbol-input-container input {
            flex: 1;
        }

        .symbol-input-container button {
            padding: 0 15px;
        }

        /* Export Button Styles */
        .export-word-btn {
            background: linear-gradient(135deg, #4285f4, #1a73e8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-word-btn:hover {
            background: linear-gradient(135deg, #1a73e8, #1557b0);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .export-word-btn i {
            font-size: 16px;
        }

        /* EmailJS Configuration Cards */
        .emailjs-config-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        body.dark .emailjs-config-card {
            background: rgba(30, 30, 30, 0.8);
            border-color: #444;
        }

        .emailjs-config-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.2);
        }

        .emailjs-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .emailjs-config-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }

        .emailjs-config-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(0, 200, 83, 0.2);
            color: var(--success);
            border: 1px solid rgba(0, 200, 83, 0.3);
        }

        .status-inactive {
            background: rgba(156, 163, 175, 0.2);
            color: #6b7280;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .emailjs-config-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .emailjs-config-actions {
            display: flex;
            gap: 10px;
        }

        .config-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .config-btn.activate {
            background: var(--success);
            color: white;
        }

        .config-btn.deactivate {
            background: var(--warning);
            color: white;
        }

        .config-btn.test {
            background: var(--primary);
            color: white;
        }

        .config-btn.edit {
            background: #6b7280;
            color: white;
        }

        .config-btn.delete {
            background: var(--danger);
            color: white;
        }

        .config-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .no-notes {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- Login/Signup Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-calculator"></i>
                    <div>
                        <div class="login-title">Precision Trading Calculator</div>
                        <div class="login-subtitle">Professional Trading Dashboard</div>
                    </div>
                </div>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div id="loginError" class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        Invalid username or password
                    </div>

                    <div class="login-input-group">
                        <input type="text" id="username" class="login-input" placeholder="Username" required
                            autocomplete="username">
                        <i class="fas fa-user login-input-icon"></i>
                    </div>

                    <div class="login-input-group">
                        <input type="password" id="password" class="login-input" placeholder="Password" required
                            autocomplete="current-password">
                        <i class="fas fa-eye-slash login-input-icon password-toggle" onclick="togglePassword()"></i>
                    </div>

                    <button type="submit" class="login-button" id="loginButton">
                        <i class="fas fa-sign-in-alt"></i>
                        Access Dashboard
                    </button>
                </form>

                <div class="divider">
                    <span>Don't have an account?</span>
                </div>

                <div class="login-links">
                    <a class="login-link" onclick="showSignupForm()">Create New Account</a>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" style="display: none;">
                <form class="signup-form" onsubmit="handleSignup(event)">
                    <div id="signupError" class="error-message"></div>
                    <div id="signupSuccess" class="success-message"></div>

                    <div class="form-group">
                        <label class="form-label" for="signupFullName">
                            <i class="fas fa-user"></i>
                            Full Name
                        </label>
                        <input type="text" id="signupFullName" class="form-input" placeholder="Enter your full name"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupUsername">
                            <i class="fas fa-at"></i>
                            Username
                        </label>
                        <input type="text" id="signupUsername" class="form-input" placeholder="Choose a username"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupEmail">
                            <i class="fas fa-envelope"></i>
                            Email Address
                        </label>
                        <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupPassword">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <input type="password" id="signupPassword" class="form-input" placeholder="Create a password"
                            required oninput="validatePassword()" autocomplete="new-password">

                        <div class="password-requirements">
                            <h4>Password Requirements:</h4>
                            <ul>
                                <li id="req-length" class="requirement-not-met">At least 8 characters long</li>
                                <li id="req-uppercase" class="requirement-not-met">Contains uppercase letter</li>
                                <li id="req-lowercase" class="requirement-not-met">Contains lowercase letter</li>
                                <li id="req-number" class="requirement-not-met">Contains at least one number</li>
                                <li id="req-special" class="requirement-not-met">Contains special character (@, #, $, %,
                                    etc.)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="signupConfirmPassword">
                            <i class="fas fa-lock"></i>
                            Confirm Password
                        </label>
                        <input type="password" id="signupConfirmPassword" class="form-input"
                            placeholder="Confirm your password" required oninput="validatePassword()"
                            autocomplete="new-password">
                    </div>

                    <!-- EmailJS Configuration Section -->
                    <div class="emailjs-section">
                        <div class="emailjs-header">
                            <div class="emailjs-title">
                                <i class="fas fa-envelope"></i>
                                Email Notifications (Optional)
                            </div>
                            <div class="toggle-switch" id="emailjsToggle" onclick="toggleEmailJSSection()"></div>
                        </div>
                        <div class="emailjs-content" id="emailjsContent">
                            <div class="emailjs-info">
                                <strong>Setup Email Notifications:</strong> Configure EmailJS to receive price alerts
                                and trade notifications.
                                <br><a href="https://www.emailjs.com/" target="_blank">Get your EmailJS credentials
                                    here</a>
                            </div>
                            <div class="emailjs-grid">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-key"></i>
                                        Public Key
                                    </label>
                                    <input type="text" id="signupPublicKey" class="form-input"
                                        placeholder="Your EmailJS Public Key">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-cog"></i>
                                        Service ID
                                    </label>
                                    <input type="text" id="signupServiceId" class="form-input"
                                        placeholder="Your EmailJS Service ID">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-file-alt"></i>
                                    Template ID
                                </label>
                                <input type="text" id="signupTemplateId" class="form-input"
                                    placeholder="Your EmailJS Template ID">
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="login-button" id="signupBtn" disabled>
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>

                <div class="divider">
                    <span>Already have an account?</span>
                </div>

                <div class="login-links">
                    <a class="login-link" onclick="showLoginForm()">Sign In Instead</a>
                </div>
            </div>

            <div class="login-features">
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span>Advanced stop loss & risk calculations with trading fees</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <span>Complete trade history & analytics with INR conversion</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <span>Real-time currency conversion with fees tracking</span>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <span>Performance analytics & fee optimization</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="main-dashboard" id="mainDashboard">
        <!-- Header with user info -->
        <div class="header">
            <div class="user-info">
                <div class="user-avatar-container" onclick="openAvatarModal()">
                    <div id="userAvatar" class="user-avatar">SB</div>
                    <div class="avatar-edit-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="user-details">
                    <h3 id="userName">Soumen Bhandari</h3>
                    <p id="userEmail">Professional Trader</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="toggle-container">
                    <span>Dark Mode</span>
                    <div class="toggle-switch" onclick="toggleTheme()"></div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>

        <div class="logo">
            <i class="fas fa-calculator logo-icon"></i>
            <h1>Precision Trading Calculator</h1>
        </div>

        <div class="dashboard-container">
            <div class="main-content">
                <!-- Main Navigation Tabs -->
                <div class="main-tabs">
                    <button class="main-tab active" onclick="switchMainTab('stop-loss-calculator')">
                        <i class="fas fa-chart-line"></i> Calculator
                    </button>
                    <button class="main-tab" onclick="switchMainTab('portfolio-tracker')">
                        <i class="fas fa-briefcase"></i> Portfolio
                    </button>
                    <button class="main-tab" onclick="switchMainTab('trade-journal')">
                        <i class="fas fa-book"></i> Journal
                    </button>
                    <button class="main-tab" onclick="switchMainTab('risk-management')">
                        <i class="fas fa-shield-alt"></i> Risk
                    </button>
                    <button class="main-tab" onclick="switchMainTab('price-alerts')">
                        <i class="fas fa-bell"></i> Alerts
                    </button>
                    <button class="main-tab" onclick="switchMainTab('trading-analytics')">
                        <i class="fas fa-chart-pie"></i> Analytics
                    </button>
                </div>

                <!-- Stop Loss Calculator Tab -->
                <div class="main-tab-content active" id="stop-loss-calculator">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-line calculator-icon"></i>
                                <span>Stop Loss Calculator with Trading Fees</span>
                            </div>
                        </div>

                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('trade-calculator')">Trade Calculator</div>
                            <div class="tab" onclick="switchTab('history')">Trade History</div>
                        </div>

                        <!-- Trade Calculator Tab -->
                        <div class="tab-content active" id="trade-calculator">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-coins"></i>
                                    <span>Asset/Symbol</span>
                                    <div class="tooltip">
                                        <div class="info-icon">i</div>
                                        <span class="tooltip-text">Enter the trading symbol (e.g., BTCUSDT,
                                            ETHUSDT)</span>
                                    </div>
                                </div>
                                <div class="symbol-input-container">
                                    <input type="text" id="assetName" class="input-field"
                                        placeholder="e.g., BTCUSDT, ETHUSDT">
                                    <button class="btn btn-secondary" onclick="fetchCurrentPrice()">
                                        <i class="fas fa-sync"></i> Get Price
                                    </button>
                                </div>
                            </div>

                            <div class="live-price-container" id="livePriceContainer" style="display: none;">
                                <div class="live-price-label">Live Price:</div>
                                <div class="live-price-value" id="livePriceValue">$--</div>
                                <div class="price-change-indicator" id="priceChangeIndicator">--</div>
                            </div>

                            <div class="price-history-chart">
                                <canvas id="priceHistoryChart"></canvas>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-tag"></i>
                                    <span>Entry Price ($)</span>
                                    <div class="tooltip">
                                        <div class="info-icon">i</div>
                                        <span class="tooltip-text">The price at which you entered the trade</span>
                                    </div>
                                </div>
                                <input type="number" id="entry" class="input-field" step="any"
                                    placeholder="Enter entry price" oninput="calc()">
                                <div class="decimal-info">Supports up to 10 decimal places</div>
                            </div>

                            <div class="row">
                                <div class="input-group">
                                    <div class="input-label">
                                        <i class="fas fa-wallet"></i>
                                        <span>Original Amount ($)</span>
                                    </div>
                                    <input type="number" id="original" class="input-field" value="5.88" step="0.01"
                                        oninput="updateLeverage()">
                                    <div class="slider-container">
                                        <input type="range" min="1" max="1000" value="5.88" step="1" class="slider"
                                            id="originalSlider" oninput="updateOriginalFromSlider()">
                                    </div>
                                </div>
                                <div class="input-group">
                                    <div class="input-label">
                                        <i class="fas fa-bolt"></i>
                                        <span>Leverage ()</span>
                                    </div>
                                    <input type="number" id="leverageX" class="input-field" value="20" step="1" min="1"
                                        max="100" oninput="updateLeverage()">
                                    <div class="slider-container">
                                        <input type="range" min="1" max="50" value="20" step="1" class="slider"
                                            id="leverageSlider" oninput="updateLeverageFromSlider()">
                                    </div>
                                </div>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-sack-dollar"></i>
                                    <span>Position Size ($)</span>
                                    <div class="tooltip">
                                        <div class="info-icon">i</div>
                                        <span class="tooltip-text">Total position size (Original Amount 
                                            Leverage)</span>
                                    </div>
                                </div>
                                <input type="number" id="leverage" class="input-field" readonly>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Risk ($)</span>
                                    <div class="tooltip">
                                        <div class="info-icon">i</div>
                                        <span class="tooltip-text">The amount you're willing to risk on this
                                            trade</span>
                                    </div>
                                </div>
                                <input type="number" id="risk" class="input-field" value=".592" step="0.01"
                                    oninput="calc()">
                                <div class="slider-container">
                                    <input type="range" min="1" max="100" value=".592" step="1" class="slider"
                                        id="riskSlider" oninput="updateRiskFromSlider()">
                                </div>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-bullseye"></i>
                                    <span>Target Price ($)</span>
                                    <div class="tooltip">
                                        <div class="info-icon">i</div>
                                        <span class="tooltip-text">Your target price for taking profits</span>
                                    </div>
                                </div>
                                <input type="number" id="target" class="input-field" step="any"
                                    placeholder="Enter target price" oninput="calc()">
                                <div class="decimal-info">Supports up to 10 decimal places</div>
                            </div>

                            <div class="position-toggle">
                                <button id="longBtn" class="position-btn active" onclick="setPosition('long')">
                                    <i class="fas fa-arrow-up"></i> Long
                                </button>
                                <button id="shortBtn" class="position-btn" onclick="setPosition('short')">
                                    <i class="fas fa-arrow-down"></i> Short
                                </button>
                            </div>

                            <div class="result-container">
                                <div class="result-item">
                                    <div class="result-label">Stop Loss Value</div>
                                    <div id="slValue" class="result-value">$--</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">Stop Loss Price</div>
                                    <div id="slPrice" class="result-value">$--</div>
                                </div>
                            </div>

                            <div class="trading-fees-container">
                                <div class="result-item">
                                    <div class="result-label">Maker Fee (0.02%)</div>
                                    <div id="makerFee" class="result-value">$--</div>
                                    <div id="makerFeeInr" class="inr-value">--</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">Taker Fee (0.05%)</div>
                                    <div id="takerFee" class="result-value">$--</div>
                                    <div id="takerFeeInr" class="inr-value">--</div>
                                </div>
                            </div>

                            <div class="profit-loss-container">
                                <div class="result-item">
                                    <div class="result-label">Potential Profit</div>
                                    <div id="profitValue" class="result-value">$--</div>
                                    <div id="profitValueInr" class="inr-value">--</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">Risk/Reward Ratio</div>
                                    <div id="rrRatio" class="result-value">--</div>
                                </div>
                            </div>

                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="resetCalculator()">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                                <button class="btn btn-primary" onclick="showTradeSummary()">
                                    <i class="fas fa-file-alt"></i> Summary
                                </button>
                                <button class="btn btn-success" onclick="saveTrade()">
                                    <i class="fas fa-save"></i> Save Trade
                                </button>
                            </div>
                        </div>

                        <!-- Trade History Tab -->
                        <div class="tab-content" id="history">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-filter"></i>
                                    <span>Filter by Position</span>
                                </div>
                                <select id="historyFilter" class="input-field" onchange="filterHistory()">
                                    <option value="all">All Trades</option>
                                    <option value="long">Long Positions</option>
                                    <option value="short">Short Positions</option>
                                </select>
                            </div>

                            <div class="history-table-container">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Time</th>
                                            <th>Asset</th>
                                            <th>Position</th>
                                            <th>Entry</th>
                                            <th>Target</th>
                                            <th>Stop Loss</th>
                                            <th>Fee Type</th>
                                            <th>Outcome</th>
                                            <th>P/L</th>
                                            <th>P/L ()</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historyTableBody">
                                        <!-- History will be populated here -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="history-actions">
                                <button class="btn btn-secondary" onclick="clearHistory()">
                                    <i class="fas fa-trash"></i> Clear History
                                </button>
                                <button class="btn btn-primary" onclick="exportHistory()">
                                    <i class="fas fa-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Tracker Tab -->
                <div class="main-tab-content" id="portfolio-tracker">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-briefcase calculator-icon"></i>
                                <span>Portfolio Tracker</span>
                            </div>
                        </div>

                        <div class="portfolio-grid">
                            <div class="portfolio-summary">
                                <div class="portfolio-value" id="portfolioValue">$0.00</div>
                                <div class="portfolio-change" id="portfolioChange">+$0.00 (0.00%)</div>
                                <p>Total Portfolio Value</p>
                            </div>
                        </div>

                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-plus"></i>
                                <span>Add Asset to Portfolio</span>
                            </div>
                            <div class="row">
                                <div>
                                    <input type="text" id="portfolioAsset" class="input-field"
                                        placeholder="Asset Symbol (e.g., BTC)">
                                </div>
                                <div>
                                    <input type="number" id="portfolioQuantity" class="input-field"
                                        placeholder="Quantity" step="any">
                                </div>
                                <div>
                                    <input type="number" id="portfolioPrice" class="input-field" placeholder="Avg Price"
                                        step="any">
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="addAssetToPortfolio()">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="asset-list" id="assetList">
                            <div class="no-notes" style="text-align: center; padding: 40px;">
                                <i class="fas fa-briefcase"
                                    style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                                <p>No assets in portfolio yet. Add your first asset!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade Journal Tab -->
                <div class="main-tab-content" id="trade-journal">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-book calculator-icon"></i>
                                <span>Trade Journal with Screenshots</span>
                            </div>
                        </div>

                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-coins"></i>
                                <span>Trade Symbol</span>
                            </div>
                            <input type="text" id="journalSymbol" class="input-field" placeholder="e.g., BTC/USD">
                        </div>

                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-image"></i>
                                <span>Chart Screenshot</span>
                            </div>
                            <div class="screenshot-upload"
                                onclick="document.getElementById('screenshotUpload').click()">
                                <i class="fas fa-camera"></i>
                                <h4>Upload Chart Screenshot</h4>
                                <p>Click to select an image file</p>
                                <input type="file" id="screenshotUpload" accept="image/*" style="display: none;"
                                    onchange="handleScreenshotUpload(event)">
                            </div>
                            <div id="screenshotPreview" style="display: none; margin-top: 15px;">
                                <img id="screenshotImage" class="screenshot-preview" alt="Chart Screenshot">
                            </div>
                        </div>

                        <div class="input-group">
                            <div class="input-label">
                                <i class="fas fa-edit"></i>
                                <span>Trade Analysis & Reasoning</span>
                            </div>
                            <textarea id="journalAnalysis" class="input-field" rows="4"
                                placeholder="Describe your trade setup, reasoning, and analysis..."></textarea>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="saveJournalEntry()">
                                <i class="fas fa-save"></i> Save Journal Entry
                            </button>
                            <button class="export-word-btn" onclick="exportJournalToWord()">
                                <i class="fas fa-file-word"></i> Export to Word
                            </button>
                        </div>

                        <div class="section-title" style="margin-top: 30px;">
                            <span>Journal Entries</span>
                        </div>

                        <div id="journalEntries">
                            <div class="no-notes" style="text-align: center; padding: 40px;">
                                <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                                <p>No journal entries yet. Add your first trade analysis!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Management Tab -->
                <div class="main-tab-content" id="risk-management">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-shield-alt calculator-icon"></i>
                                <span>Risk Management Dashboard</span>
                            </div>
                        </div>

                        <div class="risk-metrics">
                            <div class="risk-metric">
                                <div class="risk-metric-icon" style="color: var(--primary);">
                                    <i class="fas fa-wallet"></i>
                                </div>
                                <div class="risk-metric-value" id="accountBalance">$1,000.00</div>
                                <div class="risk-metric-label">Account Balance</div>
                            </div>
                            <div class="risk-metric">
                                <div class="risk-metric-icon" style="color: var(--warning);">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="risk-metric-value" id="riskPerTrade">2%</div>
                                <div class="risk-metric-label">Risk Per Trade</div>
                            </div>
                            <div class="risk-metric">
                                <div class="risk-metric-icon" style="color: var(--danger);">
                                    <i class="fas fa-chart-line-down"></i>
                                </div>
                                <div class="risk-metric-value" id="maxDrawdown">-5.2%</div>
                                <div class="risk-metric-label">Max Drawdown</div>
                            </div>
                            <div class="risk-metric">
                                <div class="risk-metric-icon" style="color: var(--success);">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="risk-metric-value" id="dailyRisk">$20.00</div>
                                <div class="risk-metric-label">Daily Risk Limit</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-wallet"></i>
                                    <span>Account Balance ($)</span>
                                </div>
                                <input type="number" id="riskAccountBalance" class="input-field" value="1000"
                                    step="0.01" oninput="updateRiskMetrics()">
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-percentage"></i>
                                    <span>Risk Per Trade (%)</span>
                                </div>
                                <input type="number" id="riskPerTradePercent" class="input-field" value="2" step="0.1"
                                    min="0.1" max="10" oninput="updateRiskMetrics()">
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-calendar-day"></i>
                                    <span>Daily Risk Limit (%)</span>
                                </div>
                                <input type="number" id="dailyRiskPercent" class="input-field" value="5" step="0.1"
                                    min="1" max="20" oninput="updateRiskMetrics()">
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-chart-line-down"></i>
                                    <span>Max Drawdown Limit (%)</span>
                                </div>
                                <input type="number" id="maxDrawdownLimit" class="input-field" value="15" step="0.1"
                                    min="5" max="50" oninput="updateRiskMetrics()">
                            </div>
                        </div>

                        <div id="riskAlert" class="risk-safe">
                            <i class="fas fa-check-circle"></i>
                            Risk levels are within safe limits
                        </div>

                        <div class="section-title">
                            <span>Position Size Calculator</span>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-tag"></i>
                                    <span>Entry Price ($)</span>
                                </div>
                                <input type="number" id="riskEntryPrice" class="input-field" step="any"
                                    oninput="calculatePositionSize()">
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-stop-circle"></i>
                                    <span>Stop Loss Price ($)</span>
                                </div>
                                <input type="number" id="riskStopPrice" class="input-field" step="any"
                                    oninput="calculatePositionSize()">
                            </div>
                        </div>

                        <div class="result-container">
                            <div class="result-item">
                                <div class="result-label">Recommended Position Size</div>
                                <div id="recommendedPosition" class="result-value">$--</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Risk Amount</div>
                                <div id="riskAmount" class="result-value">$--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Alerts Tab -->
                <div class="main-tab-content" id="price-alerts">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-bell calculator-icon"></i>
                                <span>Enhanced Price Alerts System</span>
                            </div>
                        </div>

                        <!-- EmailJS Configuration Management -->
                        <div class="section-title">
                            <span>Email Configuration</span>
                            <button class="btn btn-primary" onclick="showAddEmailJSModal()"
                                style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-plus"></i> Add EmailJS Config
                            </button>
                        </div>

                        <div id="emailjsConfigList">
                            <div class="no-notes" style="text-align: center; padding: 40px;">
                                <i class="fas fa-envelope"
                                    style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                                <p>No EmailJS configurations found. Add one to enable email notifications.</p>
                            </div>
                        </div>

                        <!-- API Status Display -->
                        <div class="api-status-container">
                            <div class="api-status-title">
                                <i class="fas fa-server"></i> API Status Monitor
                            </div>
                            <div class="api-status-list" id="apiStatusList">
                                <div class="api-status-item">
                                    <div class="api-status-indicator checking" id="binanceStatus"></div>
                                    <span>Binance API</span>
                                </div>
                                <div class="api-status-item">
                                    <div class="api-status-indicator checking" id="coinbaseStatus"></div>
                                    <span>Coinbase API</span>
                                </div>
                                <div class="api-status-item">
                                    <div class="api-status-indicator checking" id="krakenStatus"></div>
                                    <span>Kraken API</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-coins"></i>
                                    <span>Asset Symbol</span>
                                </div>
                                <input type="text" id="alertSymbol" class="input-field" placeholder="e.g., BTCUSDT">
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-arrows-alt-v"></i>
                                    <span>Condition</span>
                                </div>
                                <select id="alertCondition" class="input-field">
                                    <option value="above">Price Above</option>
                                    <option value="below">Price Below</option>
                                    <option value="change">% Change</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span>Target Price/Percentage</span>
                                </div>
                                <input type="number" id="alertPrice" class="input-field" step="any"
                                    placeholder="Enter price or percentage">
                            </div>
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-comment"></i>
                                    <span>Note (Optional)</span>
                                </div>
                                <input type="text" id="alertNote" class="input-field" placeholder="Alert description">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="createPriceAlert()">
                            <i class="fas fa-plus"></i> Create Alert
                        </button>

                        <div class="section-title" style="margin-top: 30px;">
                            <span>Active Alerts</span>
                            <button class="btn btn-secondary" onclick="clearAllAlerts()"
                                style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>

                        <div id="alertsList">
                            <div class="no-notes" style="text-align: center; padding: 40px;">
                                <i class="fas fa-bell" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                                <p>No price alerts set. Create your first alert!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trading Analytics Tab -->
                <div class="main-tab-content" id="trading-analytics">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chart-pie calculator-icon"></i>
                                <span>Advanced Trading Analytics</span>
                            </div>
                        </div>

                        <div class="total-pl-container">
                            <div class="total-pl-label">Total P/L</div>
                            <div id="totalPL" class="total-pl-value">$0.00</div>
                            <div id="totalPLInr" class="inr-value">0.00</div>
                        </div>

                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <div class="analytics-title">Sharpe Ratio</div>
                                <div class="analytics-value" id="sharpeRatio">0.00</div>
                                <div class="analytics-change" id="sharpeChange">Risk-adjusted returns</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-title">Max Consecutive Wins</div>
                                <div class="analytics-value" id="maxWinStreak">0</div>
                                <div class="analytics-change">Best winning streak</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-title">Max Consecutive Losses</div>
                                <div class="analytics-value" id="maxLossStreak">0</div>
                                <div class="analytics-change">Worst losing streak</div>
                            </div>
                            <div class="analytics-card">
                                <div class="analytics-title">Best Performing Asset</div>
                                <div class="analytics-value" id="bestAsset">--</div>
                                <div class="analytics-change" id="bestAssetProfit">$0.00</div>
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="plChart"></canvas>
                        </div>

                        <div class="section-title">
                            Trade Statistics
                            <button class="edit-btn" onclick="openEditModal()">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-percentage"></i>
                                    <span>Win Rate</span>
                                </div>
                                <input type="text" id="winRate" class="input-field" value="0%" readonly>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Avg. Profit</span>
                                </div>
                                <input type="text" id="avgProfit" class="input-field" value="$0.00" readonly>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>Avg. Loss</span>
                                </div>
                                <input type="text" id="avgLoss" class="input-field" value="$0.00" readonly>
                            </div>

                            <div class="input-group">
                                <div class="input-label">
                                    <i class="fas fa-balance-scale"></i>
                                    <span>Total Trades</span>
                                </div>
                                <input type="text" id="totalTrades" class="input-field" value="0" readonly>
                            </div>
                        </div>

                        <div class="win-loss-container">
                            <div class="win-counter">
                                <div class="win-loss-label">Total Wins</div>
                                <div id="totalWins" class="win-loss-value">0</div>
                            </div>
                            <div class="loss-counter">
                                <div class="win-loss-label">Total Losses</div>
                                <div id="totalLosses" class="win-loss-value">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Currency Converter Sidebar -->
            <div class="currency-converter-sidebar">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-exchange-alt calculator-icon"></i>
                            <span>Currency Converter</span>
                        </div>
                    </div>

                    <div class="currency-select">
                        <select id="fromCurrency" class="input-field" onchange="convertCurrency()">
                            <option value="USD" selected>USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                            <option value="JPY">JPY</option>
                            <option value="CAD">CAD</option>
                            <option value="AUD">AUD</option>
                            <option value="CHF">CHF</option>
                            <option value="CNY">CNY</option>
                            <option value="INR">INR</option>
                        </select>

                        <i class="fas fa-exchange-alt"></i>

                        <select id="toCurrency" class="input-field" onchange="convertCurrency()">
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="JPY">JPY</option>
                            <option value="CAD">CAD</option>
                            <option value="AUD">AUD</option>
                            <option value="CHF">CHF</option>
                            <option value="CNY">CNY</option>
                            <option value="INR" selected>INR</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Enter Amount</span>
                        </div>
                        <input type="number" id="amount" class="input-field" placeholder="e.g., 5.88"
                            oninput="convertCurrency()">
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            <i class="fas fa-globe"></i>
                            <span id="rateLabel">Exchange Rate</span>
                        </div>
                        <input type="number" id="rate" class="input-field" value="85" step="0.01"
                            oninput="convertCurrency()">
                    </div>

                    <div id="convertResult" class="conversion-result">
                        <div id="conversionText">Enter amount to convert</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Outcome Modal -->
    <div class="modal" id="tradeOutcomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Trade Outcome</h3>
                <button class="close-modal" onclick="closeTradeOutcomeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>How did this trade turn out?</p>
                <div class="outcome-buttons">
                    <button class="outcome-btn win" onclick="selectOutcome('win')">
                        <i class="fas fa-check-circle"></i> Win
                    </button>
                    <button class="outcome-btn loss" onclick="selectOutcome('loss')">
                        <i class="fas fa-times-circle"></i> Loss
                    </button>
                    <button class="outcome-btn pending" onclick="selectOutcome('pending')">
                        <i class="fas fa-clock"></i> Pending
                    </button>
                </div>

                <!-- Fee Selection -->
                <div class="fee-selection" id="feeSelection" style="display: none;">
                    <h4>Choose Fee Type</h4>
                    <div class="fee-buttons">
                        <button class="fee-btn maker" onclick="selectFeeType('maker')">
                            <i class="fas fa-clock"></i> Maker (0.02%)
                        </button>
                        <button class="fee-btn taker" onclick="selectFeeType('taker')">
                            <i class="fas fa-bolt"></i> Taker (0.05%)
                        </button>
                    </div>
                    <div class="fee-comparison" id="feeComparison">
                        <div class="fee-comparison-item maker">
                            <div class="fee-comparison-label">With Maker Fee</div>
                            <div class="fee-comparison-value" id="makerProfitPreview">$--</div>
                        </div>
                        <div class="fee-comparison-item taker">
                            <div class="fee-comparison-label">With Taker Fee</div>
                            <div class="fee-comparison-value" id="takerProfitPreview">$--</div>
                        </div>
                    </div>
                </div>

                <div id="outcomeInputs" style="display: none;">
                    <div class="input-group">
                        <div class="input-label">
                            <i class="fas fa-dollar-sign"></i>
                            <span id="outcomeInputLabel">Exit Price ($)</span>
                        </div>
                        <input type="number" id="outcomePrice" class="input-field" step="any"
                            placeholder="Enter exit price" oninput="updateFeeComparison()">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTradeOutcomeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="finalizeTradeOutcome()">
                    <i class="fas fa-save"></i> Save Trade
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Performance Modal -->
    <div class="modal" id="editPerformanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Performance Statistics</h3>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <div class="input-label">
                        <i class="fas fa-percentage"></i>
                        <span>Win Rate (%)</span>
                    </div>
                    <input type="number" id="editWinRate" class="editable-field" step="0.1" min="0" max="100">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <i class="fas fa-chart-line"></i>
                        <span>Average Profit ($)</span>
                    </div>
                    <input type="number" id="editAvgProfit" class="editable-field" step="0.01">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <i class="fas fa-chart-bar"></i>
                        <span>Average Loss ($)</span>
                    </div>
                    <input type="number" id="editAvgLoss" class="editable-field" step="0.01">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <i class="fas fa-trophy"></i>
                        <span>Total Wins</span>
                    </div>
                    <input type="number" id="editTotalWins" class="editable-field" min="0">
                </div>

                <div class="input-group">
                    <div class="input-label">
                        <i class="fas fa-times-circle"></i>
                        <span>Total Losses</span>
                    </div>
                    <input type="number" id="editTotalLosses" class="editable-field" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePerformanceEdits()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Avatar Upload Modal -->
    <div class="avatar-modal" id="avatarModal">
        <div class="avatar-modal-content">
            <div class="avatar-modal-header">
                <h3 class="avatar-modal-title">Update Profile Picture</h3>
                <button class="close-modal" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="avatar-preview" id="avatarPreview"></div>

                <div class="file-input-container">
                    <button class="file-input-label">
                        <i class="fas fa-upload"></i> Choose File
                    </button>
                    <input type="file" id="avatarUpload" class="file-input" accept="image/*"
                        onchange="handleImageUpload(event)">
                </div>

                <p style="margin: 15px 0; font-size: 14px; color: #666;">
                    Select an image from your computer. JPG, PNG, or GIF. Max 5MB.
                </p>

                <div class="avatar-options">
                    <div class="avatar-option"
                        style="background-image: url('data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%232962ff%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>')"
                        onclick="selectDefaultAvatar('default1')"></div>
                    <div class="avatar-option"
                        style="background-image: url('data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%23ff6d00%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>')"
                        onclick="selectDefaultAvatar('default2')"></div>
                    <div class="avatar-option"
                        style="background-image: url('data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%2300c853%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>')"
                        onclick="selectDefaultAvatar('default3')"></div>
                    <div class="avatar-option upload-option" onclick="document.getElementById('avatarUpload').click()">
                        <i class="fas fa-plus upload-icon"></i>
                        <span>Upload</span>
                    </div>
                </div>
            </div>
            <div class="avatar-modal-footer">
                <button class="btn btn-secondary" onclick="closeAvatarModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveAvatar()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- EmailJS Configuration Modal -->
    <div class="modal" id="emailjsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="emailjsModalTitle">Add EmailJS Configuration</h3>
                <button class="close-modal" onclick="closeEmailJSModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="emailjs-info">
                    <strong>Get your EmailJS credentials:</strong> Visit <a href="https://www.emailjs.com/"
                        target="_blank">EmailJS.com</a> to create an account and get your credentials.
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-tag"></i>
                        Configuration Name
                    </label>
                    <input type="text" id="emailjsConfigName" class="form-input"
                        placeholder="e.g., Personal Email, Work Email">
                </div>

                <div class="emailjs-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-key"></i>
                            Public Key
                        </label>
                        <input type="text" id="emailjsPublicKey" class="form-input"
                            placeholder="Your EmailJS Public Key">
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-cog"></i>
                            Service ID
                        </label>
                        <input type="text" id="emailjsServiceId" class="form-input"
                            placeholder="Your EmailJS Service ID">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-file-alt"></i>
                        Template ID
                    </label>
                    <input type="text" id="emailjsTemplateId" class="form-input" placeholder="Your EmailJS Template ID">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmailJSModal()">Cancel</button>
                <button class="btn btn-primary" onclick="testEmailJSConfig()">
                    <i class="fas fa-paper-plane"></i> Test Email
                </button>
                <button class="btn btn-success" onclick="saveEmailJSConfig()">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Email Notification Modal -->
    <div class="email-modal" id="emailModal">
        <div class="email-modal-content">
            <div class="email-header">
                <div class="email-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div>
                    <div class="email-title">Email Alert Sent!</div>
                </div>
            </div>
            <div class="email-body">
                <div class="email-field">
                    <div class="email-field-label">To:</div>
                    <div class="email-field-value" id="emailRecipient">user@example.com</div>
                </div>
                <div class="email-field">
                    <div class="email-field-label">Subject:</div>
                    <div class="email-field-value" id="emailSubject">Price Alert Triggered</div>
                </div>
                <div class="email-field">
                    <div class="email-field-label">Message:</div>
                    <div class="email-content" id="emailContent">
                        <!-- Email content will be populated here -->
                    </div>
                </div>
            </div>
            <div class="email-footer">
                <button class="email-close-btn" onclick="closeEmailModal()">
                    <i class="fas fa-check"></i> Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Sound -->
    <audio id="alertSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav">
        <source
            src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
            type="audio/wav">
    </audio>

    <audio id="secondaryAlertSound" preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-04.wav" type="audio/wav">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-interface-hint-notification-911.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Initialize EmailJS with proper configuration
        (function () {
            // Initialize with default public key - will be overridden by user configurations
            emailjs.init("tgdTBXzbizQIR2IaY");
        })();

        // Authentication System
        let currentUser = null;
        let selectedAvatar = null;
        let uploadedImage = null;
        let currentNotesFilter = 'today';
        let selectedFeeType = 'taker'; // Default to taker fee
        let priceHistory = [];
        let priceHistoryChart = null;
        let alertInterval = null;
        let previousPrice = null;
        let apiStatus = {
            binance: 'checking',
            coinbase: 'checking',
            kraken: 'checking'
        };
        let currentEmailJSConfig = null;
        let editingEmailJSId = null;

        // Currency conversion constants
        const USD_TO_INR_RATE = 85;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            checkLoginStatus();
        });

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } else {
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';

            // Update user info in header
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
                document.getElementById('userEmail').textContent = currentUser.email || 'Account Holder';

                // Create avatar initials
                const name = currentUser.fullName || currentUser.username;
                const initials = name.split(' ').map(name => name[0]).join('').toUpperCase().substring(0, 2);

                // Set avatar if exists
                const avatar = document.getElementById('userAvatar');
                if (currentUser.avatar) {
                    avatar.textContent = '';
                    avatar.style.backgroundImage = `url(${currentUser.avatar})`;
                } else {
                    avatar.textContent = initials;
                    avatar.style.backgroundImage = '';
                }
            }

            // Initialize the trading calculator
            initializeApp();
        }

        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            clearMessages();
            clearForms();
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            clearMessages();
            clearForms();
        }

        function clearMessages() {
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        function clearForms() {
            // Clear login form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';

            // Clear signup form
            document.getElementById('signupFullName').value = '';
            document.getElementById('signupUsername').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupConfirmPassword').value = '';

            // Clear EmailJS fields
            document.getElementById('signupPublicKey').value = '';
            document.getElementById('signupServiceId').value = '';
            document.getElementById('signupTemplateId').value = '';

            // Reset password requirements
            const requirements = ['req-length', 'req-uppercase', 'req-lowercase', 'req-number', 'req-special'];
            requirements.forEach(reqId => {
                const element = document.getElementById(reqId);
                if (element) {
                    element.className = 'requirement-not-met';
                }
            });

            // Disable signup button
            const signupBtn = document.getElementById('signupBtn');
            if (signupBtn) {
                signupBtn.disabled = true;
            }

            // Reset EmailJS toggle
            const emailjsToggle = document.getElementById('emailjsToggle');
            const emailjsContent = document.getElementById('emailjsContent');
            if (emailjsToggle && emailjsContent) {
                emailjsToggle.classList.remove('active');
                emailjsContent.classList.remove('active');
            }
        }

        // EmailJS Toggle Function
        function toggleEmailJSSection() {
            const toggle = document.getElementById('emailjsToggle');
            const content = document.getElementById('emailjsContent');

            toggle.classList.toggle('active');
            content.classList.toggle('active');
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginError = document.getElementById('loginError');

            // Hide previous error
            loginError.style.display = 'none';

            // Show loading state
            loginButton.disabled = true;
            loginButton.innerHTML = '<div class="loading"></div> Authenticating...';

            // Simulate authentication delay
            setTimeout(() => {
                // Check default admin account
                if (username === 'bytebot' && password === 'Soumen@2005') {
                    currentUser = {
                        username: 'bytebot',
                        fullName: 'Soumen Bhandari',
                        email: 'admin@tradingcalc.com',
                        isAdmin: true
                    };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showNotification('Login successful! Welcome to your trading dashboard.', 'success');
                    showDashboard();
                } else {
                    // Check registered users
                    const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                    const user = users.find(u => u.username === username && u.password === password);

                    if (user) {
                        currentUser = {
                            username: user.username,
                            fullName: user.fullName,
                            email: user.email,
                            isAdmin: false,
                            avatar: user.avatar || null,
                            emailjsConfigs: user.emailjsConfigs || []
                        };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showNotification('Login successful! Welcome back, ' + user.fullName, 'success');
                        showDashboard();
                    } else {
                        loginError.style.display = 'block';
                        showNotification('Invalid credentials. Please try again.', 'error');
                    }
                }

                // Reset button state
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Access Dashboard';
            }, 1500);
        }

        function handleSignup(event) {
            event.preventDefault();

            const fullName = document.getElementById('signupFullName').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const signupError = document.getElementById('signupError');
            const signupSuccess = document.getElementById('signupSuccess');
            const signupBtn = document.getElementById('signupBtn');

            // Get EmailJS configuration if provided
            const emailjsToggle = document.getElementById('emailjsToggle');
            const publicKey = document.getElementById('signupPublicKey').value.trim();
            const serviceId = document.getElementById('signupServiceId').value.trim();
            const templateId = document.getElementById('signupTemplateId').value.trim();

            // Hide previous messages
            signupError.style.display = 'none';
            signupSuccess.style.display = 'none';

            // Show loading state
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<div class="loading"></div> Creating account...';

            // Validate inputs
            if (!validateSignupForm(fullName, username, email, password, confirmPassword)) {
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                return;
            }

            // Check if username already exists
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');

            if (users.some(u => u.username === username)) {
                signupError.textContent = 'Username already exists. Please choose a different username.';
                signupError.style.display = 'block';
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                return;
            }

            // Check if email already exists
            if (users.some(u => u.email === email)) {
                signupError.textContent = 'Email already registered. Please use a different email.';
                signupError.style.display = 'block';
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                return;
            }

            // Create EmailJS configuration if provided
            let emailjsConfigs = [];
            if (emailjsToggle.classList.contains('active') && publicKey && serviceId && templateId) {
                emailjsConfigs.push({
                    id: Date.now().toString(),
                    name: 'Default Configuration',
                    publicKey: publicKey,
                    serviceId: serviceId,
                    templateId: templateId,
                    isActive: true,
                    createdAt: new Date().toISOString()
                });
            }

            // Create new user
            const newUser = {
                fullName,
                username,
                email,
                password,
                createdAt: new Date().toISOString(),
                avatar: null,
                emailjsConfigs: emailjsConfigs
            };

            users.push(newUser);

            try {
                localStorage.setItem('registeredUsers', JSON.stringify(users));

                // Show success message
                const configMessage = emailjsConfigs.length > 0 ? ' Email notifications have been configured.' : '';
                signupSuccess.textContent = 'Account created successfully!' + configMessage + ' You can now sign in.';
                signupSuccess.style.display = 'block';

                // Clear form
                clearForms();

                // Switch to login form after 2 seconds
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('username').value = username;
                }, 2000);

            } catch (error) {
                signupError.textContent = 'Error creating account. Please try again.';
                signupError.style.display = 'block';
            }

            // Reset button
            signupBtn.disabled = false;
            signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
        }

        function validateSignupForm(fullName, username, email, password, confirmPassword) {
            const signupError = document.getElementById('signupError');
            signupError.style.display = 'none';

            // Full name validation
            if (fullName.length < 2) {
                signupError.textContent = 'Full name must be at least 2 characters long.';
                signupError.style.display = 'block';
                return false;
            }

            // Username validation
            if (username.length < 3) {
                signupError.textContent = 'Username must be at least 3 characters long.';
                signupError.style.display = 'block';
                return false;
            }

            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                signupError.textContent = 'Username can only contain letters, numbers, and underscores.';
                signupError.style.display = 'block';
                return false;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                signupError.textContent = 'Please enter a valid email address.';
                signupError.style.display = 'block';
                return false;
            }

            // Password validation
            if (!isPasswordValid(password)) {
                signupError.textContent = 'Password does not meet the requirements.';
                signupError.style.display = 'block';
                return false;
            }

            // Confirm password validation
            if (password !== confirmPassword) {
                signupError.textContent = 'Passwords do not match.';
                signupError.style.display = 'block';
                return false;
            }

            return true;
        }

        function validatePassword() {
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const signupBtn = document.getElementById('signupBtn');

            // Check each requirement
            const requirements = {
                'req-length': password.length >= 8,
                'req-uppercase': /[A-Z]/.test(password),
                'req-lowercase': /[a-z]/.test(password),
                'req-number': /\d/.test(password),
                'req-special': /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            // Update requirement indicators
            Object.keys(requirements).forEach(reqId => {
                const element = document.getElementById(reqId);
                if (element) {
                    if (requirements[reqId]) {
                        element.className = 'requirement-met';
                    } else {
                        element.className = 'requirement-not-met';
                    }
                }
            });

            // Enable/disable signup button
            const allMet = Object.values(requirements).every(met => met);
            const passwordsMatch = password === confirmPassword;

            signupBtn.disabled = !(allMet && passwordsMatch && password.length > 0 && confirmPassword.length > 0);
        }

        function isPasswordValid(password) {
            return password.length >= 8 &&
                /[A-Z]/.test(password) &&
                /[a-z]/.test(password) &&
                /\d/.test(password) &&
                /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.querySelector('.password-toggle');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear user session
                localStorage.removeItem('currentUser');
                currentUser = null;

                // Show logout notification
                showNotification('Logging out...', 'info');

                // Clear form fields
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';

                setTimeout(() => {
                    showLoginPage();
                }, 1000);
            }
        }

        // EmailJS Configuration Management
        function showAddEmailJSModal() {
            editingEmailJSId = null;
            document.getElementById('emailjsModalTitle').textContent = 'Add EmailJS Configuration';
            document.getElementById('emailjsConfigName').value = '';
            document.getElementById('emailjsPublicKey').value = '';
            document.getElementById('emailjsServiceId').value = '';
            document.getElementById('emailjsTemplateId').value = '';
            document.getElementById('emailjsModal').style.display = 'flex';
        }

        function showEditEmailJSModal(configId) {
            const configs = loadUserData('emailjsConfigs') || [];
            const config = configs.find(c => c.id === configId);

            if (!config) return;

            editingEmailJSId = configId;
            document.getElementById('emailjsModalTitle').textContent = 'Edit EmailJS Configuration';
            document.getElementById('emailjsConfigName').value = config.name;
            document.getElementById('emailjsPublicKey').value = config.publicKey;
            document.getElementById('emailjsServiceId').value = config.serviceId;
            document.getElementById('emailjsTemplateId').value = config.templateId;
            document.getElementById('emailjsModal').style.display = 'flex';
        }

        function closeEmailJSModal() {
            document.getElementById('emailjsModal').style.display = 'none';
            editingEmailJSId = null;
        }

        function testEmailJSConfig() {
            const name = document.getElementById('emailjsConfigName').value.trim();
            const publicKey = document.getElementById('emailjsPublicKey').value.trim();
            const serviceId = document.getElementById('emailjsServiceId').value.trim();
            const templateId = document.getElementById('emailjsTemplateId').value.trim();

            if (!name || !publicKey || !serviceId || !templateId) {
                showNotification('Please fill in all fields before testing', 'error');
                return;
            }

            if (!currentUser || !currentUser.email) {
                showNotification('User email not found', 'error');
                return;
            }

            // Test the configuration
            const testParams = {
                name: currentUser.fullName || currentUser.username,
                title: 'Test Email Configuration',
                user_email: currentUser.email,
                crypto_name: 'Bitcoin',
                target_price: '50000',
                alert_date: new Date().toLocaleString(),
                alert_id: 'TEST-' + Date.now()
            };

            // Temporarily initialize EmailJS with test config
            emailjs.init(publicKey);

            emailjs.send(serviceId, templateId, testParams)
                .then(function (response) {
                    showNotification('Test email sent successfully! Check your inbox.', 'success');
                })
                .catch(function (error) {
                    showNotification('Test email failed: ' + error.text, 'error');
                });
        }

        function saveEmailJSConfig() {
            const name = document.getElementById('emailjsConfigName').value.trim();
            const publicKey = document.getElementById('emailjsPublicKey').value.trim();
            const serviceId = document.getElementById('emailjsServiceId').value.trim();
            const templateId = document.getElementById('emailjsTemplateId').value.trim();

            if (!name || !publicKey || !serviceId || !templateId) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            const configs = loadUserData('emailjsConfigs') || [];

            if (editingEmailJSId) {
                // Edit existing config
                const configIndex = configs.findIndex(c => c.id === editingEmailJSId);
                if (configIndex !== -1) {
                    configs[configIndex] = {
                        ...configs[configIndex],
                        name: name,
                        publicKey: publicKey,
                        serviceId: serviceId,
                        templateId: templateId,
                        updatedAt: new Date().toISOString()
                    };
                }
            } else {
                // Add new config
                const newConfig = {
                    id: Date.now().toString(),
                    name: name,
                    publicKey: publicKey,
                    serviceId: serviceId,
                    templateId: templateId,
                    isActive: configs.length === 0, // First config is active by default
                    createdAt: new Date().toISOString()
                };
                configs.push(newConfig);
            }

            if (saveUserData('emailjsConfigs', configs)) {
                // Update user's emailjsConfigs in registered users
                updateUserEmailJSConfigs(configs);

                loadEmailJSConfigs();
                closeEmailJSModal();
                showNotification(editingEmailJSId ? 'Configuration updated successfully!' : 'Configuration added successfully!', 'success');
            } else {
                showNotification('Error saving configuration', 'error');
            }
        }

        function updateUserEmailJSConfigs(configs) {
            if (!currentUser) return;

            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser.username);

            if (userIndex !== -1) {
                users[userIndex].emailjsConfigs = configs;
                localStorage.setItem('registeredUsers', JSON.stringify(users));

                // Update current user object
                currentUser.emailjsConfigs = configs;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function loadEmailJSConfigs() {
            const configs = loadUserData('emailjsConfigs') || [];
            const container = document.getElementById('emailjsConfigList');

            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="no-notes" style="text-align: center; padding: 40px;">
                        <i class="fas fa-envelope" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No EmailJS configurations found. Add one to enable email notifications.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            configs.forEach(config => {
                const statusClass = config.isActive ? 'status-active' : 'status-inactive';
                const statusText = config.isActive ? 'Active' : 'Inactive';
                const cardClass = config.isActive ? 'active' : '';

                html += `
                    <div class="emailjs-config-card ${cardClass}">
                        <div class="emailjs-config-header">
                            <div class="emailjs-config-name">${config.name}</div>
                            <div class="emailjs-config-status ${statusClass}">${statusText}</div>
                        </div>
                        <div class="emailjs-config-details">
                            Service: ${config.serviceId} | Template: ${config.templateId}
                        </div>
                        <div class="emailjs-config-actions">
                            ${!config.isActive ? `
                                <button class="config-btn activate" onclick="activateEmailJSConfig('${config.id}')">
                                    <i class="fas fa-play"></i> Activate
                                </button>
                            ` : `
                                <button class="config-btn deactivate" onclick="deactivateEmailJSConfig('${config.id}')">
                                    <i class="fas fa-pause"></i> Deactivate
                                </button>
                            `}
                            <button class="config-btn test" onclick="testEmailJSConfigById('${config.id}')">
                                <i class="fas fa-paper-plane"></i> Test
                            </button>
                            <button class="config-btn edit" onclick="showEditEmailJSModal('${config.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="config-btn delete" onclick="deleteEmailJSConfig('${config.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function activateEmailJSConfig(configId) {
            const configs = loadUserData('emailjsConfigs') || [];

            // Deactivate all configs
            configs.forEach(config => config.isActive = false);

            // Activate selected config
            const targetConfig = configs.find(c => c.id === configId);
            if (targetConfig) {
                targetConfig.isActive = true;

                if (saveUserData('emailjsConfigs', configs)) {
                    updateUserEmailJSConfigs(configs);
                    loadEmailJSConfigs();
                    showNotification('Configuration activated successfully!', 'success');
                }
            }
        }

        function deactivateEmailJSConfig(configId) {
            const configs = loadUserData('emailjsConfigs') || [];
            const targetConfig = configs.find(c => c.id === configId);

            if (targetConfig) {
                targetConfig.isActive = false;

                if (saveUserData('emailjsConfigs', configs)) {
                    updateUserEmailJSConfigs(configs);
                    loadEmailJSConfigs();
                    showNotification('Configuration deactivated', 'info');
                }
            }
        }

        function testEmailJSConfigById(configId) {
            const configs = loadUserData('emailjsConfigs') || [];
            const config = configs.find(c => c.id === configId);

            if (!config) {
                showNotification('Configuration not found', 'error');
                return;
            }

            if (!currentUser || !currentUser.email) {
                showNotification('User email not found', 'error');
                return;
            }

            const testParams = {
                name: currentUser.fullName || currentUser.username,
                title: `Test Email from ${config.name}`,
                user_email: currentUser.email,
                crypto_name: 'Bitcoin',
                target_price: '50000',
                alert_date: new Date().toLocaleString(),
                alert_id: 'TEST-' + Date.now()
            };

            // Temporarily initialize EmailJS with config
            emailjs.init(config.publicKey);

            emailjs.send(config.serviceId, config.templateId, testParams)
                .then(function (response) {
                    showNotification(`Test email sent successfully from ${config.name}!`, 'success');
                })
                .catch(function (error) {
                    showNotification(`Test email failed: ${error.text}`, 'error');
                });
        }

        function deleteEmailJSConfig(configId) {
            if (confirm('Are you sure you want to delete this EmailJS configuration?')) {
                const configs = loadUserData('emailjsConfigs') || [];
                const filteredConfigs = configs.filter(c => c.id !== configId);

                if (saveUserData('emailjsConfigs', filteredConfigs)) {
                    updateUserEmailJSConfigs(filteredConfigs);
                    loadEmailJSConfigs();
                    showNotification('Configuration deleted successfully!', 'success');
                }
            }
        }

        function getActiveEmailJSConfig() {
            const configs = loadUserData('emailjsConfigs') || [];
            return configs.find(config => config.isActive);
        }

        // User Data Management Functions
        function getUserStorageKey(key) {
            return currentUser ? `${currentUser.username}_${key}` : key;
        }

        function saveUserData(key, data) {
            const userKey = getUserStorageKey(key);
            return saveToLocalStorage(userKey, data);
        }

        function loadUserData(key) {
            const userKey = getUserStorageKey(key);
            return loadFromLocalStorage(userKey);
        }

        // Update existing functions to use user-specific storage
        function saveToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showNotification('Error saving data. Storage may be full.', 'error');
                return false;
            }
        }

        function loadFromLocalStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        // Global variables
        let currentTradeData = null;
        let selectedOutcome = null;
        let currentScreenshot = null;

        // Currency conversion functions
        function convertToINR(usdAmount) {
            return usdAmount * USD_TO_INR_RATE;
        }

        function formatINR(amount) {
            return `${amount.toFixed(2)}`;
        }

        function initializeApp() {
            // Load saved theme preference
            const savedTheme = loadUserData('darkMode');
            if (savedTheme === 'true') {
                document.body.classList.add('dark');
            }

            // Initialize calculator
            updateLeverage();
            calc();

            // Load and display saved data
            loadTrades();
            updatePerformanceAnalytics();
            initializeChart();

            // Set up currency converter
            convertCurrency();

            // Initialize new features
            loadPortfolio();
            loadJournalEntries();
            updateRiskMetrics();
            loadPriceAlerts();
            updateAdvancedAnalytics();
            loadEmailJSConfigs();

            // Initialize price history chart
            initializePriceHistoryChart();

            // Start alert monitoring
            startAlertMonitoring();

            // Initialize API status monitoring
            initializeAPIStatusMonitoring();

            showNotification('Trading Dashboard loaded successfully!', 'success');
        }

        // Enhanced API Status Monitoring
        function initializeAPIStatusMonitoring() {
            // Check API status every 60 seconds
            checkAPIStatus();
            setInterval(checkAPIStatus, 60000);
        }

        async function checkAPIStatus() {
            const apis = [
                { name: 'binance', url: 'https://api.binance.com/api/v3/ping', elementId: 'binanceStatus' },
                { name: 'coinbase', url: 'https://api.coinbase.com/v2/time', elementId: 'coinbaseStatus' },
                { name: 'kraken', url: 'https://api.kraken.com/0/public/SystemStatus', elementId: 'krakenStatus' }
            ];

            for (const api of apis) {
                try {
                    const response = await fetch(api.url, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });

                    if (response.ok) {
                        apiStatus[api.name] = 'online';
                        updateAPIStatusIndicator(api.elementId, 'online');
                    } else {
                        apiStatus[api.name] = 'offline';
                        updateAPIStatusIndicator(api.elementId, 'offline');
                    }
                } catch (error) {
                    apiStatus[api.name] = 'offline';
                    updateAPIStatusIndicator(api.elementId, 'offline');
                }
            }
        }

        function updateAPIStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `api-status-indicator ${status}`;
            }
        }

        // Enhanced Email Notification System
        async function sendEmailNotification(alertData) {
            const activeConfig = getActiveEmailJSConfig();

            if (!activeConfig) {
                console.log('No active EmailJS configuration found');
                showNotification('No active email configuration. Please configure EmailJS in the Alerts tab.', 'warning');
                return false;
            }

            if (!currentUser || !currentUser.email) {
                console.log('No user email available for notification');
                return false;
            }

            // Fixed email template parameters
            const emailData = {
                name: currentUser.fullName || currentUser.username,
                title: `Price Alert for ${alertData.symbol} at $${alertData.targetPrice}`,
                user_email: currentUser.email,
                crypto_name: alertData.symbol,
                target_price: alertData.targetPrice,
                alert_date: new Date().toLocaleString(),
                alert_id: 'ALERT-' + Date.now()
            };

            try {
                // Initialize EmailJS with active configuration
                emailjs.init(activeConfig.publicKey);

                // Send email using active configuration
                const result = await emailjs.send(activeConfig.serviceId, activeConfig.templateId, emailData);

                console.log('Email notification sent successfully:', result);
                showNotification(`Alert email sent successfully via ${activeConfig.name}!`, 'success');

                // Show email modal with the content that was sent
                showEmailModal(emailData);

                return true;
            } catch (error) {
                console.error('Failed to send email notification:', error);
                showNotification(`Failed to send email via ${activeConfig.name}: ${error.text}`, 'error');
                return false;
            }
        }

        function showEmailModal(emailData) {
            const modal = document.getElementById('emailModal');
            const recipient = document.getElementById('emailRecipient');
            const subject = document.getElementById('emailSubject');
            const content = document.getElementById('emailContent');

            recipient.textContent = emailData.user_email;
            subject.textContent = emailData.title;

            // Create a simple email content preview
            content.innerHTML = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2> Price Alert Triggered!</h2>
                    <p>Hi ${emailData.name},</p>
                    <p>Your price alert for <strong>${emailData.crypto_name}</strong> has been triggered!</p>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <strong>Alert Details:</strong><br>
                        - Cryptocurrency: ${emailData.crypto_name}<br>
                        - Target Price: $${emailData.target_price}<br>
                        - Alert ID: ${emailData.alert_id}<br>
                        - Created: ${emailData.alert_date}
                    </div>
                    <p>Best regards,<br>The Pro Trading Team</p>
                </div>
            `;

            modal.classList.add('show');
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            modal.classList.remove('show');
        }

        // Enhanced Alert Notification System
        function showEnhancedAlertNotification(symbol, conditionText, currentPrice, note = '') {
            // Remove any existing alert notifications
            const existingAlerts = document.querySelectorAll('.alert-notification');
            existingAlerts.forEach(alert => alert.remove());

            const notification = document.createElement('div');
            notification.className = 'alert-notification';
            notification.innerHTML = `
                <i class="fas fa-bell bell-icon"></i>
                <div class="alert-notification-content">
                    <div class="alert-notification-title">${symbol} Alert Triggered!</div>
                    <div class="alert-notification-details">
                        ${conditionText} - Current: $${currentPrice.toFixed(2)}
                        ${note ? `<br><small>${note}</small>` : ''}
                    </div>
                </div>
                <button class="alert-notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        // Enhanced Sound and Vibration System
        function playEnhancedAlertSound() {
            try {
                // Try to play primary alert sound
                const primarySound = document.getElementById('alertSound');
                if (primarySound) {
                    primarySound.currentTime = 0;
                    primarySound.play().catch(() => {
                        // If primary fails, try secondary sound
                        const secondarySound = document.getElementById('secondaryAlertSound');
                        if (secondarySound) {
                            secondarySound.currentTime = 0;
                            secondarySound.play().catch(() => {
                                console.log('Audio playback failed - user interaction may be required');
                            });
                        }
                    });
                }

                // Try to vibrate device if supported
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }
            } catch (error) {
                console.log('Alert sound/vibration error:', error);
            }
        }

        // Main Tab Navigation
        function switchMainTab(tabId) {
            // Hide all main tab contents
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all main tabs
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected main tab content
            document.getElementById(tabId).classList.add('active');

            // Set active class on clicked main tab
            event.target.classList.add('active');
        }

        // Calculator Functions
        function updateLeverage() {
            const original = parseFloat(document.getElementById("original").value) || 0;
            const leverageX = parseFloat(document.getElementById("leverageX").value) || 0;

            if (original > 0 && leverageX > 0) {
                const leverage = original * leverageX;
                document.getElementById("leverage").value = leverage.toFixed(2);
                calc();
            }
        }

        function updateOriginalFromSlider() {
            const value = document.getElementById("originalSlider").value;
            document.getElementById("original").value = value;
            updateLeverage();
        }

        function updateLeverageFromSlider() {
            const value = document.getElementById("leverageSlider").value;
            document.getElementById("leverageX").value = value;
            updateLeverage();
        }

        function updateRiskFromSlider() {
            const value = document.getElementById("riskSlider").value;
            document.getElementById("risk").value = value;
            calc();
        }

        function setPosition(type) {
            document.getElementById("longBtn").classList.toggle("active", type === "long");
            document.getElementById("shortBtn").classList.toggle("active", type === "short");
            calc();
        }

        function calc() {
            const entry = parseFloat(document.getElementById("entry").value) || 0;
            const leverage = parseFloat(document.getElementById("leverage").value) || 0;
            const risk = parseFloat(document.getElementById("risk").value) || 0;
            const target = parseFloat(document.getElementById("target").value) || 0;
            const isLong = document.getElementById("longBtn").classList.contains("active");

            if (entry <= 0 || leverage <= 0 || risk <= 0) {
                document.getElementById("slValue").textContent = "$--";
                document.getElementById("slPrice").textContent = "$--";
                document.getElementById("profitValue").textContent = "$--";
                document.getElementById("profitValueInr").textContent = "--";
                document.getElementById("rrRatio").textContent = "--";
                document.getElementById("makerFee").textContent = "$--";
                document.getElementById("makerFeeInr").textContent = "--";
                document.getElementById("takerFee").textContent = "$--";
                document.getElementById("takerFeeInr").textContent = "--";
                return;
            }

            // Calculate trading fees based on position size
            const positionSize = leverage; // This is the leveraged position size
            const makerFeeRate = 0.02 / 100; // 0.02%
            const takerFeeRate = 0.05 / 100; // 0.05%

            const makerFeeAmount = positionSize * makerFeeRate;
            const takerFeeAmount = positionSize * takerFeeRate;

            // Display trading fees
            document.getElementById("makerFee").textContent = `$${makerFeeAmount.toFixed(4)}`;
            document.getElementById("makerFeeInr").textContent = formatINR(convertToINR(makerFeeAmount));
            document.getElementById("takerFee").textContent = `$${takerFeeAmount.toFixed(4)}`;
            document.getElementById("takerFeeInr").textContent = formatINR(convertToINR(takerFeeAmount));

            // Calculate stop loss
            const slValue = (entry * risk) / leverage;
            const slPrice = isLong ? (entry - slValue) : (entry + slValue);

            // Calculate profit and risk/reward ratio
            let profitValue = 0;
            let rrRatio = "--";

            if (target > 0) {
                const priceDiff = Math.abs(target - entry);
                profitValue = (priceDiff * leverage) / entry;

                if ((isLong && target > entry) || (!isLong && target < entry)) {
                    rrRatio = (profitValue / risk).toFixed(2) + ":1";
                } else {
                    profitValue = 0;
                    rrRatio = "--";
                }
            }

            // Display with 10 decimal places for stop loss values
            document.getElementById("slValue").textContent = `$${slValue.toFixed(10)}`;
            document.getElementById("slPrice").textContent = `$${slPrice.toFixed(10)}`;
            document.getElementById("profitValue").textContent = `$${profitValue.toFixed(2)}`;
            document.getElementById("profitValueInr").textContent = formatINR(convertToINR(profitValue));
            document.getElementById("rrRatio").textContent = rrRatio;
        }

        function resetCalculator() {
            document.getElementById("assetName").value = "";
            document.getElementById("entry").value = "";
            document.getElementById("original").value = "5.88";
            document.getElementById("originalSlider").value = "5.88";
            document.getElementById("leverageX").value = "20";
            document.getElementById("leverageSlider").value = "20";
            document.getElementById("risk").value = ".592";
            document.getElementById("riskSlider").value = ".592";
            document.getElementById("target").value = "";
            document.getElementById("longBtn").classList.add("active");
            document.getElementById("shortBtn").classList.remove("active");

            updateLeverage();
            calc();
            showNotification('Calculator reset successfully!', 'info');
        }

        // Enhanced Multi-API Price Fetching with proper button state management
        async function fetchCurrentPrice() {
            const symbolInput = document.getElementById('assetName').value.trim().toUpperCase();
            const symbol = symbolInput.replace('/', '');
            const button = document.querySelector('.symbol-input-container .btn');

            if (!symbol) {
                showNotification('Please enter a cryptocurrency symbol', 'error');
                return;
            }

            try {
                // Show loading state
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="loading"></div>';
                button.disabled = true;

                const price = await getCryptoPriceWithFallback(symbol);
                if (price) {
                    document.getElementById('entry').value = price;
                    document.getElementById('livePriceValue').textContent = `$${price.toFixed(2)}`;
                    document.getElementById('livePriceContainer').style.display = 'flex';

                    // Add to price history
                    const timestamp = new Date();
                    priceHistory.push({
                        time: timestamp.toLocaleTimeString(),
                        price: price
                    });

                    // Keep only the last 20 prices
                    if (priceHistory.length > 20) {
                        priceHistory.shift();
                    }

                    // Update price history chart
                    updatePriceHistoryChart();

                    calc();
                    showNotification(`Current price of ${symbol}: $${price.toFixed(2)}`, 'success');
                } else {
                    showNotification('Failed to fetch price from all APIs for ' + symbol, 'error');
                }
            } catch (error) {
                console.error('Error fetching price:', error);
                showNotification('Error fetching price. Please try again.', 'error');
            } finally {
                // Always reset button state
                button.innerHTML = '<i class="fas fa-sync"></i> Get Price';
                button.disabled = false;
            }
        }

        async function getCryptoPriceWithFallback(symbol) {
            const apis = [
                {
                    name: 'Binance',
                    url: `https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`,
                    parser: (data) => parseFloat(data.price)
                },
                {
                    name: 'Coinbase',
                    url: `https://api.coinbase.com/v2/exchange-rates?currency=${symbol.replace('USDT', '')}`,
                    parser: (data) => parseFloat(data.data.rates.USD)
                },
                {
                    name: 'Kraken',
                    url: `https://api.kraken.com/0/public/Ticker?pair=${symbol.replace('USDT', 'USD')}`,
                    parser: (data) => {
                        const pair = Object.keys(data.result)[0];
                        return parseFloat(data.result[pair].c[0]);
                    }
                }
            ];

            for (const api of apis) {
                try {
                    console.log(`Trying ${api.name} API...`);
                    const response = await fetch(api.url);
                    const data = await response.json();

                    if (response.ok && data) {
                        const price = api.parser(data);
                        if (price && !isNaN(price)) {
                            console.log(`Successfully fetched price from ${api.name}: $${price}`);
                            return price;
                        }
                    }
                } catch (error) {
                    console.log(`${api.name} API failed:`, error.message);
                    continue;
                }
            }

            return null;
        }

        function initializePriceHistoryChart() {
            const ctx = document.getElementById('priceHistoryChart').getContext('2d');
            priceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Price History',
                        data: [],
                        borderColor: '#2962ff',
                        backgroundColor: 'rgba(41, 98, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    }
                }
            });
        }

        function updatePriceHistoryChart() {
            if (!priceHistoryChart) return;

            const labels = priceHistory.map(item => item.time);
            const data = priceHistory.map(item => item.price);

            priceHistoryChart.data.labels = labels;
            priceHistoryChart.data.datasets[0].data = data;
            priceHistoryChart.update();

            // Update price change indicator
            if (priceHistory.length > 1) {
                const currentPrice = priceHistory[priceHistory.length - 1].price;
                const previousPrice = priceHistory[priceHistory.length - 2].price;
                const change = currentPrice - previousPrice;
                const changePercent = (change / previousPrice) * 100;

                const indicator = document.getElementById('priceChangeIndicator');
                indicator.textContent = `${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                indicator.className = 'price-change-indicator ' + (change >= 0 ? 'price-up' : 'price-down');
            }
        }

        // Enhanced Alert Functions
        function startAlertMonitoring() {
            // Clear any existing interval
            if (alertInterval) {
                clearInterval(alertInterval);
            }

            // Check alerts every 30 seconds
            alertInterval = setInterval(checkAlerts, 30000);
        }

        async function checkAlerts() {
            const alerts = loadUserData('priceAlerts') || [];
            const activeAlerts = alerts.filter(alert => alert.status === 'active');

            if (activeAlerts.length === 0) return;

            for (const alert of activeAlerts) {
                try {
                    const currentPrice = await getCryptoPriceWithFallback(alert.symbol);
                    if (currentPrice === null) continue;

                    // Update current price in alert display
                    updateAlertCurrentPrice(alert.id, currentPrice);

                    let triggered = false;
                    let conditionText = '';

                    if (alert.condition === 'above' && currentPrice >= alert.targetPrice) {
                        triggered = true;
                        conditionText = `Price above $${alert.targetPrice}`;
                    } else if (alert.condition === 'below' && currentPrice <= alert.targetPrice) {
                        triggered = true;
                        conditionText = `Price below $${alert.targetPrice}`;
                    }

                    if (triggered) {
                        // Update alert status
                        alert.status = 'triggered';
                        alert.triggeredAt = new Date().toISOString();
                        alert.triggeredPrice = currentPrice;

                        // Show enhanced notification
                        showEnhancedAlertNotification(alert.symbol, conditionText, currentPrice, alert.note);

                        // Play enhanced alert sound
                        playEnhancedAlertSound();

                        // Send email notification
                        await sendEmailNotification({
                            symbol: alert.symbol,
                            conditionText: conditionText,
                            targetPrice: alert.targetPrice,
                            currentPrice: currentPrice,
                            note: alert.note
                        });

                        // Show regular notification as well
                        showNotification(` ${alert.symbol} alert triggered! ${conditionText}`, 'warning');
                    }
                } catch (error) {
                    console.error(`Error checking alert for ${alert.symbol}:`, error);
                }
            }

            // Save updated alerts
            saveUserData('priceAlerts', alerts);
            loadPriceAlerts(); // Refresh the display
        }

        function updateAlertCurrentPrice(alertId, currentPrice) {
            // This function updates the current price display in the alerts list
            const alertItems = document.querySelectorAll('.alert-item');
            alertItems.forEach(item => {
                if (item.dataset.alertId === alertId) {
                    const currentPriceElement = item.querySelector('.alert-current-price');
                    if (currentPriceElement) {
                        currentPriceElement.innerHTML = `
                            <i class="fas fa-chart-line"></i>
                            Current: $${currentPrice.toFixed(2)}
                        `;
                    }
                }
            });
        }

        // Trade Management Functions
        function saveTrade() {
            try {
                // Validate inputs
                const assetName = document.getElementById("assetName").value.trim();
                const entry = parseFloat(document.getElementById("entry").value);
                const target = parseFloat(document.getElementById("target").value) || 0;
                const slPriceText = document.getElementById("slPrice").textContent.replace('$', '');
                const slPrice = parseFloat(slPriceText);
                const position = document.getElementById("longBtn").classList.contains("active") ? "Long" : "Short";
                const leverage = parseFloat(document.getElementById("leverage").value);
                const risk = parseFloat(document.getElementById("risk").value);
                const originalAmount = parseFloat(document.getElementById("original").value);
                const leverageX = parseFloat(document.getElementById("leverageX").value);

                // Calculate fees
                const positionSize = leverage;
                const makerFee = positionSize * (0.02 / 100);
                const takerFee = positionSize * (0.05 / 100);

                // Validation
                if (!assetName) {
                    showNotification("Please enter an asset/symbol name", "error");
                    return;
                }
                if (!entry || entry <= 0) {
                    showNotification("Please enter a valid entry price", "error");
                    return;
                }
                if (!leverage || leverage <= 0) {
                    showNotification("Please calculate position size first", "error");
                    return;
                }
                if (!risk || risk <= 0) {
                    showNotification("Please enter a valid risk amount", "error");
                    return;
                }
                if (!slPrice || slPrice <= 0) {
                    showNotification("Please calculate stop loss first", "error");
                    return;
                }

                // Create trade data
                currentTradeData = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    asset: assetName,
                    position: position,
                    entry: entry,
                    target: target,
                    stopLoss: slPrice,
                    leverage: leverage,
                    risk: risk,
                    originalAmount: originalAmount,
                    leverageX: leverageX,
                    makerFee: makerFee,
                    takerFee: takerFee,
                    outcome: null,
                    profit: 0,
                    exitPrice: null,
                    feeType: null,
                    usedFee: 0
                };

                // Show outcome modal
                document.getElementById('tradeOutcomeModal').style.display = 'flex';
                selectedOutcome = null;
                selectedFeeType = 'taker'; // Reset to default

                // Reset modal state
                document.getElementById('outcomeInputs').style.display = 'none';
                document.getElementById('feeSelection').style.display = 'none';
                document.getElementById('outcomePrice').value = '';

                // Reset button states
                document.querySelectorAll('.outcome-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelectorAll('.fee-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });

            } catch (error) {
                console.error("Error in saveTrade:", error);
                showNotification("Error preparing trade data. Please try again.", "error");
            }
        }

        function selectOutcome(outcome) {
            selectedOutcome = outcome;

            // Update button states
            document.querySelectorAll('.outcome-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Show/hide inputs based on outcome
            if (outcome === 'win' || outcome === 'loss') {
                document.getElementById('outcomeInputs').style.display = 'block';
                document.getElementById('feeSelection').style.display = 'block';
                document.getElementById('outcomeInputLabel').textContent = 'Exit Price ($)';
                document.getElementById('outcomePrice').placeholder = 'Enter exit price';

                // Select default taker fee
                selectFeeType('taker');
            } else {
                document.getElementById('outcomeInputs').style.display = 'none';
                document.getElementById('feeSelection').style.display = 'none';
            }
        }

        function selectFeeType(feeType) {
            selectedFeeType = feeType;

            // Update button states
            document.querySelectorAll('.fee-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.fee-btn.${feeType}`).classList.add('selected');

            // Update fee comparison
            updateFeeComparison();
        }

        function updateFeeComparison() {
            if (!currentTradeData) return;

            const exitPrice = parseFloat(document.getElementById('outcomePrice').value);
            if (!exitPrice || exitPrice <= 0) {
                document.getElementById('makerProfitPreview').textContent = '$--';
                document.getElementById('takerProfitPreview').textContent = '$--';
                return;
            }

            const entry = currentTradeData.entry;
            const originalAmount = currentTradeData.originalAmount;
            const leverageX = currentTradeData.leverageX;
            const isLong = currentTradeData.position === 'Long';

            const priceDiff = isLong ? (exitPrice - entry) : (entry - exitPrice);
            const percentageChange = priceDiff / entry;
            let baseProfit = originalAmount * percentageChange * leverageX;

            // Calculate with maker fee
            const makerProfit = baseProfit - currentTradeData.makerFee;
            document.getElementById('makerProfitPreview').textContent = `$${makerProfit.toFixed(2)}`;

            // Calculate with taker fee
            const takerProfit = baseProfit - currentTradeData.takerFee;
            document.getElementById('takerProfitPreview').textContent = `$${takerProfit.toFixed(2)}`;
        }

        function finalizeTradeOutcome() {
            try {
                if (!selectedOutcome) {
                    showNotification('Please select a trade outcome', 'error');
                    return;
                }

                if (!currentTradeData) {
                    showNotification('Trade data not found', 'error');
                    return;
                }

                let finalProfit = 0;
                let exitPrice = null;
                let usedFee = 0;

                if (selectedOutcome === 'win' || selectedOutcome === 'loss') {
                    exitPrice = parseFloat(document.getElementById('outcomePrice').value);
                    if (!exitPrice || exitPrice <= 0) {
                        showNotification('Please enter a valid exit price', 'error');
                        return;
                    }

                    if (!selectedFeeType) {
                        showNotification('Please select a fee type', 'error');
                        return;
                    }

                    // Calculate profit/loss
                    const entry = currentTradeData.entry;
                    const originalAmount = currentTradeData.originalAmount;
                    const leverageX = currentTradeData.leverageX;
                    const isLong = currentTradeData.position === 'Long';

                    const priceDiff = isLong ? (exitPrice - entry) : (entry - exitPrice);
                    const percentageChange = priceDiff / entry;
                    finalProfit = originalAmount * percentageChange * leverageX;

                    // Subtract selected fee
                    usedFee = selectedFeeType === 'maker' ? currentTradeData.makerFee : currentTradeData.takerFee;
                    finalProfit -= usedFee;

                    // Ensure correct sign for losses
                    if (selectedOutcome === 'loss' && finalProfit > 0) {
                        finalProfit = -Math.abs(finalProfit);
                    }
                    // Ensure correct sign for wins
                    if (selectedOutcome === 'win' && finalProfit < 0) {
                        finalProfit = Math.abs(finalProfit);
                    }
                }

                // Update trade data
                currentTradeData.outcome = selectedOutcome;
                currentTradeData.profit = finalProfit;
                currentTradeData.exitPrice = exitPrice;
                currentTradeData.feeType = selectedFeeType;
                currentTradeData.usedFee = usedFee;

                // Save to localStorage
                const trades = loadUserData('trades') || [];
                trades.push(currentTradeData);

                if (saveUserData('trades', trades)) {
                    // Update total P/L if trade is completed
                    if (selectedOutcome !== 'pending') {
                        updateTotalPL(finalProfit);
                    }

                    // Update display
                    loadTrades();
                    updatePerformanceAnalytics();
                    updateAdvancedAnalytics();
                    closeTradeOutcomeModal();

                    showNotification("Trade saved successfully!", "success");
                } else {
                    showNotification("Error saving trade. Please try again.", "error");
                }

            } catch (error) {
                console.error("Error in finalizeTradeOutcome:", error);
                showNotification("Error saving trade. Please try again.", "error");
            }
        }

        function closeTradeOutcomeModal() {
            document.getElementById('tradeOutcomeModal').style.display = 'none';
            currentTradeData = null;
            selectedOutcome = null;
            selectedFeeType = 'taker';
        }

        // History Management Functions
        function loadTrades() {
            const trades = loadUserData('trades') || [];
            renderHistory(trades);
        }

        function renderHistory(trades = null) {
            try {
                if (!trades) {
                    trades = loadUserData('trades') || [];
                }

                const filter = document.getElementById("historyFilter").value;
                const tableBody = document.getElementById("historyTableBody");

                // Clear table
                tableBody.innerHTML = "";

                // Filter trades
                let filteredTrades = trades;
                if (filter !== "all") {
                    filteredTrades = trades.filter(trade =>
                        trade.position.toLowerCase() === filter
                    );
                }

                // Sort by date (newest first)
                filteredTrades.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Render trades
                if (filteredTrades.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 20px;">No trades recorded yet</td></tr>`;
                    return;
                }

                filteredTrades.forEach(trade => {
                    const row = document.createElement("tr");

                    // Format outcome
                    let outcomeHtml = '';
                    let profitHtml = '';
                    let profitInrHtml = '';

                    if (trade.outcome === 'win') {
                        outcomeHtml = '<span class="outcome-icon outcome-win"><i class="fas fa-check"></i></span> Win';
                        profitHtml = `<span class="profit">+$${Math.abs(trade.profit).toFixed(2)}</span>`;
                        profitInrHtml = `<span class="profit">${formatINR(convertToINR(Math.abs(trade.profit)))}</span>`;
                    } else if (trade.outcome === 'loss') {
                        outcomeHtml = '<span class="outcome-icon outcome-loss"><i class="fas fa-times"></i></span> Loss';
                        profitHtml = `<span class="loss">-$${Math.abs(trade.profit).toFixed(2)}</span>`;
                        profitInrHtml = `<span class="loss">-${formatINR(convertToINR(Math.abs(trade.profit)))}</span>`;
                    } else {
                        outcomeHtml = '<span class="outcome-icon outcome-pending"><i class="fas fa-clock"></i></span> Pending';
                        profitHtml = `<button class="mark-outcome-btn" onclick="updateTradeOutcome('${trade.id}')">Mark</button>`;
                        profitInrHtml = '--';
                    }

                    // Format fee type
                    let feeTypeHtml = '--';
                    if (trade.feeType) {
                        const feeColor = trade.feeType === 'maker' ? '#2196f3' : '#ff6d00';
                        feeTypeHtml = `<span style="color: ${feeColor}; font-weight: 600;">${trade.feeType.charAt(0).toUpperCase() + trade.feeType.slice(1)}</span>`;
                    }

                    row.innerHTML = `
                        <td>${trade.date}</td>
                        <td>${trade.time || '--'}</td>
                        <td>${trade.asset}</td>
                        <td>${trade.position}</td>
                        <td>$${trade.entry.toFixed(10)}</td>
                        <td>${trade.target > 0 ? '$' + trade.target.toFixed(10) : '--'}</td>
                        <td>$${trade.stopLoss.toFixed(10)}</td>
                        <td>${feeTypeHtml}</td>
                        <td>${outcomeHtml}</td>
                        <td>${profitHtml}</td>
                        <td>${profitInrHtml}</td>
                        <td class="action-buttons">
                            <button class="delete-btn" onclick="deleteTrade('${trade.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error("Error in renderHistory:", error);
                showNotification("Error loading trade history", "error");
            }
        }

        // Function to delete a trade
        function deleteTrade(tradeId) {
            if (confirm("Are you sure you want to delete this trade?")) {
                try {
                    const trades = loadUserData('trades') || [];
                    const tradeIndex = trades.findIndex(t => t.id === tradeId);

                    if (tradeIndex !== -1) {
                        // Remove trade and update P/L if trade was completed
                        const trade = trades[tradeIndex];
                        if (trade.outcome !== 'pending') {
                            updateTotalPL(-trade.profit);
                        }

                        trades.splice(tradeIndex, 1);

                        if (saveUserData('trades', trades)) {
                            loadTrades();
                            updatePerformanceAnalytics();
                            updateAdvancedAnalytics();
                            showNotification("Trade deleted successfully!", "success");
                        } else {
                            showNotification("Error deleting trade. Please try again.", "error");
                        }
                    }
                } catch (error) {
                    console.error("Error deleting trade:", error);
                    showNotification("Error deleting trade", "error");
                }
            }
        }

        function filterHistory() {
            loadTrades();
            showNotification('History filtered successfully', 'info');
        }

        function clearHistory() {
            if (confirm("Are you sure you want to clear all trade history? This action cannot be undone.")) {
                const userKey = getUserStorageKey('trades');
                localStorage.removeItem(userKey);
                const plKey = getUserStorageKey('totalPL');
                localStorage.removeItem(plKey);
                const plHistoryKey = getUserStorageKey('plHistory');
                localStorage.removeItem(plHistoryKey);

                loadTrades();
                updatePerformanceAnalytics();
                updateAdvancedAnalytics();
                showNotification("Trade history cleared successfully", "warning");
            }
        }

        function exportHistory() {
            try {
                const trades = loadUserData('trades') || [];

                if (trades.length === 0) {
                    showNotification("No trades to export", "error");
                    return;
                }

                // Create CSV content
                let csv = "Date,Time,Asset,Position,Entry,Target,Stop Loss,Fee Type,Used Fee,Outcome,Profit/Loss USD,Profit/Loss INR\n";

                trades.forEach(trade => {
                    const outcome = trade.outcome === 'win' ? 'Win' :
                        trade.outcome === 'loss' ? 'Loss' : 'Pending';
                    const profit = trade.outcome === 'pending' ? '0' : trade.profit.toFixed(2);
                    const profitINR = trade.outcome === 'pending' ? '0' : convertToINR(trade.profit).toFixed(2);
                    const feeType = trade.feeType || 'N/A';
                    const usedFee = trade.usedFee ? trade.usedFee.toFixed(4) : '0';

                    csv += `${trade.date},${trade.time || '--'},${trade.asset},${trade.position},$${trade.entry.toFixed(10)},${trade.target > 0 ? '$' + trade.target.toFixed(10) : '--'},$${trade.stopLoss.toFixed(10)},${feeType},$${usedFee},${outcome},$${profit},${profitINR}\n`;
                });

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trading_history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification("History exported successfully!", "success");

            } catch (error) {
                console.error("Error exporting history:", error);
                showNotification("Error exporting history", "error");
            }
        }

        // Portfolio Tracker Functions
        function addAssetToPortfolio() {
            const symbol = document.getElementById('portfolioAsset').value.trim().toUpperCase();
            const quantity = parseFloat(document.getElementById('portfolioQuantity').value);
            const price = parseFloat(document.getElementById('portfolioPrice').value);

            if (!symbol || !quantity || !price || quantity <= 0 || price <= 0) {
                showNotification('Please fill all fields with valid values', 'error');
                return;
            }

            const portfolio = loadUserData('portfolio') || [];

            // Check if asset already exists
            const existingAsset = portfolio.find(asset => asset.symbol === symbol);
            if (existingAsset) {
                // Update existing asset (average price calculation)
                const totalValue = (existingAsset.quantity * existingAsset.avgPrice) + (quantity * price);
                const totalQuantity = existingAsset.quantity + quantity;
                existingAsset.avgPrice = totalValue / totalQuantity;
                existingAsset.quantity = totalQuantity;
            } else {
                // Add new asset
                portfolio.push({
                    id: Date.now().toString(),
                    symbol: symbol,
                    quantity: quantity,
                    avgPrice: price,
                    currentPrice: price, // In real app, this would be fetched from API
                    addedDate: new Date().toISOString()
                });
            }

            if (saveUserData('portfolio', portfolio)) {
                // Clear inputs
                document.getElementById('portfolioAsset').value = '';
                document.getElementById('portfolioQuantity').value = '';
                document.getElementById('portfolioPrice').value = '';

                loadPortfolio();
                showNotification('Asset added to portfolio successfully!', 'success');
            } else {
                showNotification('Error adding asset to portfolio', 'error');
            }
        }

        function loadPortfolio() {
            const portfolio = loadUserData('portfolio') || [];
            const assetList = document.getElementById('assetList');

            if (portfolio.length === 0) {
                assetList.innerHTML = `
                    <div class="no-notes" style="text-align: center; padding: 40px;">
                        <i class="fas fa-briefcase" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No assets in portfolio yet. Add your first asset!</p>
                    </div>
                `;
                updatePortfolioSummary(0, 0);
                return;
            }

            let totalValue = 0;
            let totalChange = 0;
            let html = '';

            portfolio.forEach(asset => {
                // Simulate price changes (in real app, fetch from API)
                const priceChange = (Math.random() - 0.5) * 0.1; // 5% random change
                asset.currentPrice = asset.avgPrice * (1 + priceChange);

                const value = asset.quantity * asset.currentPrice;
                const change = value - (asset.quantity * asset.avgPrice);
                const changePercent = (change / (asset.quantity * asset.avgPrice)) * 100;

                totalValue += value;
                totalChange += change;

                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSign = change >= 0 ? '+' : '';

                html += `
                    <div class="asset-item">
                        <div class="asset-info">
                            <div class="asset-icon">${asset.symbol.substring(0, 2)}</div>
                            <div class="asset-details">
                                <h4>${asset.symbol}</h4>
                                <p>${asset.quantity.toFixed(4)} @ $${asset.avgPrice.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="asset-values">
                            <div class="asset-value">$${value.toFixed(2)}</div>
                            <div class="asset-change ${changeClass}">
                                ${changeSign}$${Math.abs(change).toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)
                            </div>
                        </div>
                        <button class="delete-btn" onclick="removeAssetFromPortfolio('${asset.id}')" style="margin-left: 15px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });

            assetList.innerHTML = html;
            updatePortfolioSummary(totalValue, totalChange);

            // Save updated portfolio with current prices
            saveUserData('portfolio', portfolio);
        }

        function updatePortfolioSummary(totalValue, totalChange) {
            const portfolioValue = document.getElementById('portfolioValue');
            const portfolioChange = document.getElementById('portfolioChange');

            portfolioValue.textContent = `$${totalValue.toFixed(2)}`;

            const changePercent = totalValue > 0 ? (totalChange / (totalValue - totalChange)) * 100 : 0;
            const changeSign = totalChange >= 0 ? '+' : '';
            const changeClass = totalChange >= 0 ? 'positive' : 'negative';

            portfolioChange.textContent = `${changeSign}$${Math.abs(totalChange).toFixed(2)} (${changeSign}${changePercent.toFixed(2)}%)`;
            portfolioChange.className = `portfolio-change ${changeClass}`;
        }

        function removeAssetFromPortfolio(assetId) {
            if (confirm('Are you sure you want to remove this asset from your portfolio?')) {
                const portfolio = loadUserData('portfolio') || [];
                const filteredPortfolio = portfolio.filter(asset => asset.id !== assetId);

                if (saveUserData('portfolio', filteredPortfolio)) {
                    loadPortfolio();
                    showNotification('Asset removed from portfolio', 'success');
                } else {
                    showNotification('Error removing asset', 'error');
                }
            }
        }

        // Trade Journal Functions
        function handleScreenshotUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image file (JPEG, PNG, GIF)', 'error');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File size exceeds 5MB limit', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                currentScreenshot = e.target.result;
                document.getElementById('screenshotImage').src = currentScreenshot;
                document.getElementById('screenshotPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function saveJournalEntry() {
            const symbol = document.getElementById('journalSymbol').value.trim();
            const analysis = document.getElementById('journalAnalysis').value.trim();

            if (!symbol || !analysis) {
                showNotification('Please fill in symbol and analysis fields', 'error');
                return;
            }

            const entry = {
                id: Date.now().toString(),
                symbol: symbol.toUpperCase(),
                analysis: analysis,
                screenshot: currentScreenshot,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                timestamp: new Date().getTime()
            };

            const journal = loadUserData('tradeJournal') || [];
            journal.unshift(entry);

            if (saveUserData('tradeJournal', journal)) {
                // Clear form
                document.getElementById('journalSymbol').value = '';
                document.getElementById('journalAnalysis').value = '';
                document.getElementById('screenshotPreview').style.display = 'none';
                document.getElementById('screenshotUpload').value = '';
                currentScreenshot = null;

                loadJournalEntries();
                showNotification('Journal entry saved successfully!', 'success');
            } else {
                showNotification('Error saving journal entry', 'error');
            }
        }

        function loadJournalEntries() {
            const journal = loadUserData('tradeJournal') || [];
            const container = document.getElementById('journalEntries');

            if (journal.length === 0) {
                container.innerHTML = `
                    <div class="no-notes" style="text-align: center; padding: 40px;">
                        <i class="fas fa-book" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No journal entries yet. Add your first trade analysis!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            journal.forEach(entry => {
                html += `
                    <div class="journal-entry">
                        <div class="journal-header">
                            <div>
                                <h3>${entry.symbol}</h3>
                                <div class="journal-meta">
                                    <span><i class="fas fa-calendar"></i> ${entry.date}</span>
                                    <span><i class="fas fa-clock"></i> ${entry.time}</span>
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteJournalEntry('${entry.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        ${entry.screenshot ? `
                            <div class="screenshot-container">
                                <img src="${entry.screenshot}" class="screenshot-preview" onclick="openImageModal('${entry.screenshot}')" alt="Trade Screenshot">
                            </div>
                        ` : ''}
                        
                        <div class="note-content">${entry.analysis}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportJournalToWord() {
            try {
                const journal = loadUserData('tradeJournal') || [];

                if (journal.length === 0) {
                    showNotification('No journal entries to export', 'error');
                    return;
                }

                // Create a simple Word document content
                let wordContent = `
                    <html>
                        <head>
                            <meta charset="utf-8">
                            <title>Trade Journal Export</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #2962ff; text-align: center; border-bottom: 2px solid #2962ff; padding-bottom: 10px; }
                                .entry { margin-bottom: 30px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; }
                                .entry-header { background: #f8f9fa; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 10px 10px 0 0; }
                                .symbol { font-size: 18px; font-weight: bold; color: #2962ff; }
                                .date-time { font-size: 12px; color: #666; margin-top: 5px; }
                                .analysis { line-height: 1.6; margin-top: 15px; }
                                .screenshot-note { color: #888; font-style: italic; margin-top: 10px; }
                            </style>
                        </head>
                        <body>
                            <h1>Trading Journal Export</h1>
                            <p style="text-align: center; color: #666;">Export Date: ${new Date().toLocaleDateString()}</p>
                `;

                journal.forEach((entry, index) => {
                    wordContent += `
                        <div class="entry">
                            <div class="entry-header">
                                <div class="symbol">${entry.symbol}</div>
                                <div class="date-time">${entry.date} at ${entry.time}</div>
                            </div>
                            <div class="analysis">${entry.analysis.replace(/\n/g, '<br>')}</div>
                            ${entry.screenshot ? '<div class="screenshot-note"> Chart screenshot attached to original entry</div>' : ''}
                        </div>
                    `;
                });

                wordContent += `
                        </body>
                    </html>
                `;

                // Create and download the file
                const blob = new Blob([wordContent], { type: 'application/msword' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `trade_journal_${new Date().toISOString().split('T')[0]}.doc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showNotification('Journal exported to Word document successfully!', 'success');

            } catch (error) {
                console.error('Error exporting journal to Word:', error);
                showNotification('Error exporting journal. Please try again.', 'error');
            }
        }

        function deleteJournalEntry(entryId) {
            if (confirm('Are you sure you want to delete this journal entry?')) {
                const journal = loadUserData('tradeJournal') || [];
                const filteredJournal = journal.filter(entry => entry.id !== entryId);

                if (saveUserData('tradeJournal', filteredJournal)) {
                    loadJournalEntries();
                    showNotification('Journal entry deleted successfully!', 'success');
                } else {
                    showNotification('Error deleting journal entry', 'error');
                }
            }
        }

        function openImageModal(imageSrc) {
            // Create modal for full-size image viewing
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 20px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Chart Screenshot</h3>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${imageSrc}" style="max-width: 100%; max-height: 70vh; border-radius: 10px;">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Risk Management Functions
        function updateRiskMetrics() {
            const accountBalance = parseFloat(document.getElementById('riskAccountBalance').value) || 0;
            const riskPerTradePercent = parseFloat(document.getElementById('riskPerTradePercent').value) || 0;
            const dailyRiskPercent = parseFloat(document.getElementById('dailyRiskPercent').value) || 0;
            const maxDrawdownLimit = parseFloat(document.getElementById('maxDrawdownLimit').value) || 0;

            // Update display values
            document.getElementById('accountBalance').textContent = `$${accountBalance.toFixed(2)}`;
            document.getElementById('riskPerTrade').textContent = `${riskPerTradePercent}%`;
            document.getElementById('dailyRisk').textContent = `$${(accountBalance * dailyRiskPercent / 100).toFixed(2)}`;

            // Calculate current drawdown from trades
            const trades = loadUserData('trades') || [];
            const completedTrades = trades.filter(trade => trade.outcome && trade.outcome !== 'pending');
            let currentDrawdown = 0;
            let peak = accountBalance;
            let runningBalance = accountBalance;

            completedTrades.forEach(trade => {
                runningBalance += trade.profit;
                if (runningBalance > peak) {
                    peak = runningBalance;
                }
                const drawdown = ((peak - runningBalance) / peak) * 100;
                if (drawdown > currentDrawdown) {
                    currentDrawdown = drawdown;
                }
            });

            document.getElementById('maxDrawdown').textContent = `-${currentDrawdown.toFixed(1)}%`;

            // Update risk alert
            const riskAlert = document.getElementById('riskAlert');
            if (currentDrawdown > maxDrawdownLimit || riskPerTradePercent > 5) {
                riskAlert.className = 'risk-warning';
                riskAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Risk levels are above recommended limits!';
            } else {
                riskAlert.className = 'risk-safe';
                riskAlert.innerHTML = '<i class="fas fa-check-circle"></i> Risk levels are within safe limits';
            }

            // Save risk settings
            const riskSettings = {
                accountBalance,
                riskPerTradePercent,
                dailyRiskPercent,
                maxDrawdownLimit
            };
            saveUserData('riskSettings', riskSettings);

            // Update position size calculation
            calculatePositionSize();
        }

        function calculatePositionSize() {
            const entryPrice = parseFloat(document.getElementById('riskEntryPrice').value);
            const stopPrice = parseFloat(document.getElementById('riskStopPrice').value);
            const accountBalance = parseFloat(document.getElementById('riskAccountBalance').value) || 0;
            const riskPerTradePercent = parseFloat(document.getElementById('riskPerTradePercent').value) || 0;

            if (!entryPrice || !stopPrice || entryPrice === stopPrice) {
                document.getElementById('recommendedPosition').textContent = '$--';
                document.getElementById('riskAmount').textContent = '$--';
                return;
            }

            const riskAmount = accountBalance * (riskPerTradePercent / 100);
            const priceRisk = Math.abs(entryPrice - stopPrice);
            const positionSize = riskAmount / (priceRisk / entryPrice);

            document.getElementById('recommendedPosition').textContent = `$${positionSize.toFixed(2)}`;
            document.getElementById('riskAmount').textContent = `$${riskAmount.toFixed(2)}`;
        }

        // Enhanced Price Alerts Functions
        function createPriceAlert() {
            const symbol = document.getElementById('alertSymbol').value.trim().toUpperCase();
            const condition = document.getElementById('alertCondition').value;
            const price = parseFloat(document.getElementById('alertPrice').value);
            const note = document.getElementById('alertNote').value.trim();

            if (!symbol || !price || price <= 0) {
                showNotification('Please fill in symbol and price fields', 'error');
                return;
            }

            const alert = {
                id: Date.now().toString(),
                symbol: symbol,
                condition: condition,
                targetPrice: price,
                note: note,
                status: 'active',
                createdDate: new Date().toLocaleDateString(),
                createdTime: new Date().toLocaleTimeString(),
                currentPrice: null
            };

            const alerts = loadUserData('priceAlerts') || [];
            alerts.unshift(alert);

            if (saveUserData('priceAlerts', alerts)) {
                // Clear form
                document.getElementById('alertSymbol').value = '';
                document.getElementById('alertPrice').value = '';
                document.getElementById('alertNote').value = '';

                loadPriceAlerts();
                showNotification('Price alert created successfully!', 'success');
            } else {
                showNotification('Error creating price alert', 'error');
            }
        }

        function loadPriceAlerts() {
            const alerts = loadUserData('priceAlerts') || [];
            const container = document.getElementById('alertsList');

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="no-notes" style="text-align: center; padding: 40px;">
                        <i class="fas fa-bell" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No price alerts set. Create your first alert!</p>
                    </div>
                `;
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                const conditionText = alert.condition === 'above' ? 'Above' :
                    alert.condition === 'below' ? 'Below' : '% Change';
                const priceText = alert.condition === 'change' ? `${alert.targetPrice}%` : `$${alert.targetPrice}`;
                const statusClass = alert.status === 'triggered' ? 'triggered' : 'active';

                html += `
                    <div class="alert-item ${statusClass}" data-alert-id="${alert.id}">
                        <div class="alert-info">
                            <div class="alert-symbol">${alert.symbol}</div>
                            <div class="alert-condition">${conditionText} ${priceText}</div>
                            <div class="alert-current-price">
                                <i class="fas fa-chart-line"></i>
                                Current: ${alert.currentPrice ? '$' + alert.currentPrice.toFixed(2) : 'Loading...'}
                            </div>
                            ${alert.note ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">${alert.note}</div>` : ''}
                        </div>
                        <div class="alert-price">$${alert.targetPrice}</div>
                        <div class="alert-status alert-${alert.status}">${alert.status}</div>
                        <div class="alert-actions">
                            <button class="delete-btn" onclick="deletePriceAlert('${alert.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function deletePriceAlert(alertId) {
            if (confirm('Are you sure you want to delete this price alert?')) {
                const alerts = loadUserData('priceAlerts') || [];
                const filteredAlerts = alerts.filter(alert => alert.id !== alertId);

                if (saveUserData('priceAlerts', filteredAlerts)) {
                    loadPriceAlerts();
                    showNotification('Price alert deleted successfully!', 'success');
                } else {
                    showNotification('Error deleting price alert', 'error');
                }
            }
        }

        function clearAllAlerts() {
            if (confirm('Are you sure you want to clear all price alerts?')) {
                const userKey = getUserStorageKey('priceAlerts');
                localStorage.removeItem(userKey);
                loadPriceAlerts();
                showNotification('All price alerts cleared', 'warning');
            }
        }

        // Advanced Analytics Functions
        function updateAdvancedAnalytics() {
            const trades = loadUserData('trades') || [];
            const completedTrades = trades.filter(trade => trade.outcome && trade.outcome !== 'pending');

            if (completedTrades.length === 0) {
                document.getElementById('sharpeRatio').textContent = '0.00';
                document.getElementById('maxWinStreak').textContent = '0';
                document.getElementById('maxLossStreak').textContent = '0';
                document.getElementById('bestAsset').textContent = '--';
                document.getElementById('bestAssetProfit').textContent = '$0.00';
                return;
            }

            // Calculate Sharpe Ratio (simplified)
            const returns = completedTrades.map(trade => trade.profit);
            const avgReturn = returns.reduce((sum, ret) => sum + ret, 0) / returns.length;
            const variance = returns.reduce((sum, ret) => sum + Math.pow(ret - avgReturn, 2), 0) / returns.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev) : 0;

            document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);

            // Calculate win/loss streaks
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;

            completedTrades.forEach(trade => {
                if (trade.profit > 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                }
            });

            document.getElementById('maxWinStreak').textContent = maxWinStreak;
            document.getElementById('maxLossStreak').textContent = maxLossStreak;

            // Find best performing asset
            const assetPerformance = {};
            completedTrades.forEach(trade => {
                if (!assetPerformance[trade.asset]) {
                    assetPerformance[trade.asset] = 0;
                }
                assetPerformance[trade.asset] += trade.profit;
            });

            let bestAsset = '--';
            let bestProfit = 0;
            Object.entries(assetPerformance).forEach(([asset, profit]) => {
                if (profit > bestProfit) {
                    bestAsset = asset;
                    bestProfit = profit;
                }
            });

            document.getElementById('bestAsset').textContent = bestAsset;
            document.getElementById('bestAssetProfit').textContent = `$${bestProfit.toFixed(2)}`;
        }

        // Performance Analytics Functions
        function updateTotalPL(profit) {
            const userKey = getUserStorageKey('totalPL');
            const currentTotal = parseFloat(localStorage.getItem(userKey)) || 0;
            const newTotal = currentTotal + profit;
            localStorage.setItem(userKey, newTotal.toString());

            // Update P/L history for chart
            const plHistory = loadUserData('plHistory') || [];
            plHistory.push({
                date: new Date().toLocaleDateString(),
                profit: profit,
                total: newTotal
            });
            saveUserData('plHistory', plHistory);

            // Update display
            displayTotalPL();
            updateChart();
        }

        function displayTotalPL() {
            const userKey = getUserStorageKey('totalPL');
            const totalPL = parseFloat(localStorage.getItem(userKey)) || 0;
            const totalPLElement = document.getElementById('totalPL');
            const totalPLInrElement = document.getElementById('totalPLInr');

            totalPLElement.textContent = `$${totalPL.toFixed(2)}`;
            totalPLInrElement.textContent = formatINR(convertToINR(totalPL));

            totalPLElement.className = 'total-pl-value';

            if (totalPL > 0) {
                totalPLElement.classList.add('positive');
            } else if (totalPL < 0) {
                totalPLElement.classList.add('negative');
            }
        }

        function updatePerformanceAnalytics() {
            try {
                // Load custom performance data if exists
                const customPerformance = loadUserData('customPerformance');

                if (customPerformance) {
                    // Use custom data
                    document.getElementById('winRate').value = `${customPerformance.winRate}%`;
                    document.getElementById('avgProfit').value = `$${customPerformance.avgProfit}`;
                    document.getElementById('avgLoss').value = `$${customPerformance.avgLoss}`;
                    document.getElementById('totalTrades').value = customPerformance.totalWins + customPerformance.totalLosses;
                    document.getElementById('totalWins').textContent = customPerformance.totalWins;
                    document.getElementById('totalLosses').textContent = customPerformance.totalLosses;
                } else {
                    // Calculate from actual trades
                    const trades = loadUserData('trades') || [];
                    const completedTrades = trades.filter(trade => trade.outcome && trade.outcome !== 'pending');

                    if (completedTrades.length === 0) {
                        document.getElementById('winRate').value = '0%';
                        document.getElementById('avgProfit').value = '$0.00';
                        document.getElementById('avgLoss').value = '$0.00';
                        document.getElementById('totalTrades').value = '0';
                        document.getElementById('totalWins').textContent = '0';
                        document.getElementById('totalLosses').textContent = '0';
                        return;
                    }

                    const winningTrades = completedTrades.filter(trade => trade.profit > 0);
                    const losingTrades = completedTrades.filter(trade => trade.profit < 0);

                    const winRate = ((winningTrades.length / completedTrades.length) * 100).toFixed(1);
                    const avgProfit = winningTrades.length > 0 ?
                        (winningTrades.reduce((sum, trade) => sum + trade.profit, 0) / winningTrades.length).toFixed(2) : '0.00';
                    const avgLoss = losingTrades.length > 0 ?
                        Math.abs(losingTrades.reduce((sum, trade) => sum + trade.profit, 0) / losingTrades.length).toFixed(2) : '0.00';

                    // Update display
                    document.getElementById('winRate').value = `${winRate}%`;
                    document.getElementById('avgProfit').value = `$${avgProfit}`;
                    document.getElementById('avgLoss').value = `$${avgLoss}`;
                    document.getElementById('totalTrades').value = completedTrades.length;
                    document.getElementById('totalWins').textContent = winningTrades.length;
                    document.getElementById('totalLosses').textContent = losingTrades.length;
                }

                // Update chart
                updateChart();

                // Update total P/L display
                displayTotalPL();

            } catch (error) {
                console.error("Error updating performance analytics:", error);
            }
        }

        function initializeChart() {
            try {
                const ctx = document.getElementById('plChart').getContext('2d');
                window.plChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Start'],
                        datasets: [{
                            label: 'Cumulative P/L',
                            data: [0],
                            borderColor: '#2962ff',
                            backgroundColor: 'rgba(41, 98, 255, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value) {
                                        return '$' + value.toFixed(2);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing chart:", error);
            }
        }

        function updateChart() {
            if (!window.plChart || !window.plChart.data || !window.plChart.data.datasets) return;

            try {
                const plHistory = loadUserData('plHistory') || [];

                if (plHistory.length === 0) {
                    window.plChart.data.labels = ['Start'];
                    window.plChart.data.datasets[0].data = [0];
                    window.plChart.update();
                    return;
                }

                const labels = ['Start'];
                const data = [0];
                let cumulative = 0;

                plHistory.forEach((entry, index) => {
                    cumulative += entry.profit;
                    labels.push(`Trade ${index + 1}`);
                    data.push(cumulative);
                });

                window.plChart.data.labels = labels;
                window.plChart.data.datasets[0].data = data;
                window.plChart.update();

            } catch (error) {
                console.error("Error updating chart:", error);
            }
        }

        // Edit Performance Functions
        function openEditModal() {
            // Load current values
            const customPerformance = loadUserData('customPerformance');

            if (customPerformance) {
                document.getElementById('editWinRate').value = customPerformance.winRate;
                document.getElementById('editAvgProfit').value = customPerformance.avgProfit;
                document.getElementById('editAvgLoss').value = customPerformance.avgLoss;
                document.getElementById('editTotalWins').value = customPerformance.totalWins;
                document.getElementById('editTotalLosses').value = customPerformance.totalLosses;
            } else {
                // Use current displayed values
                const winRate = parseFloat(document.getElementById('winRate').value.replace('%', '')) || 0;
                const avgProfit = parseFloat(document.getElementById('avgProfit').value.replace('$', '')) || 0;
                const avgLoss = parseFloat(document.getElementById('avgLoss').value.replace('$', '')) || 0;
                const totalWins = parseInt(document.getElementById('totalWins').textContent) || 0;
                const totalLosses = parseInt(document.getElementById('totalLosses').textContent) || 0;

                document.getElementById('editWinRate').value = winRate;
                document.getElementById('editAvgProfit').value = avgProfit;
                document.getElementById('editAvgLoss').value = avgLoss;
                document.getElementById('editTotalWins').value = totalWins;
                document.getElementById('editTotalLosses').value = totalLosses;
            }

            document.getElementById('editPerformanceModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editPerformanceModal').style.display = 'none';
        }

        function savePerformanceEdits() {
            try {
                const winRate = parseFloat(document.getElementById('editWinRate').value) || 0;
                const avgProfit = parseFloat(document.getElementById('editAvgProfit').value) || 0;
                const avgLoss = parseFloat(document.getElementById('editAvgLoss').value) || 0;
                const totalWins = parseInt(document.getElementById('editTotalWins').value) || 0;
                const totalLosses = parseInt(document.getElementById('editTotalLosses').value) || 0;

                // Validate inputs
                if (winRate < 0 || winRate > 100) {
                    showNotification('Win rate must be between 0 and 100', 'error');
                    return;
                }

                if (avgLoss < 0) {
                    showNotification('Average loss cannot be negative', 'error');
                    return;
                }

                if (totalWins < 0 || totalLosses < 0) {
                    showNotification('Win/Loss counts cannot be negative', 'error');
                    return;
                }

                // Save custom performance data
                const customPerformance = {
                    winRate: winRate,
                    avgProfit: avgProfit.toFixed(2),
                    avgLoss: avgLoss.toFixed(2),
                    totalWins: totalWins,
                    totalLosses: totalLosses
                };

                if (saveUserData('customPerformance', customPerformance)) {
                    updatePerformanceAnalytics();
                    closeEditModal();
                    showNotification('Performance statistics updated successfully!', 'success');
                } else {
                    showNotification('Error saving performance data', 'error');
                }

            } catch (error) {
                console.error('Error saving performance edits:', error);
                showNotification('Error saving performance data', 'error');
            }
        }

        // Currency Converter Functions
        function convertCurrency() {
            const amount = parseFloat(document.getElementById("amount").value) || 0;
            const rate = parseFloat(document.getElementById("rate").value) || 1;
            const fromCurrency = document.getElementById("fromCurrency").value;
            const toCurrency = document.getElementById("toCurrency").value;

            // Update rate label
            document.getElementById("rateLabel").textContent = `1 ${fromCurrency} = ${rate} ${toCurrency}`;

            if (amount > 0) {
                const converted = amount * rate;
                document.getElementById("conversionText").textContent =
                    `${amount.toFixed(2)} ${fromCurrency} = ${converted.toFixed(2)} ${toCurrency}`;
                document.getElementById("convertResult").style.display = "block";
            } else {
                document.getElementById("convertResult").style.display = "none";
            }
        }

        // UI Functions
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabId).classList.add('active');

            // Set active class on clicked tab
            event.target.classList.add('active');
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle("dark");
            saveUserData('darkMode', body.classList.contains('dark'));
            showNotification('Theme changed successfully!', 'info');
        }

        function showTradeSummary() {
            const assetName = document.getElementById("assetName").value || "Not specified";
            const entry = document.getElementById("entry").value || "Not specified";
            const leverage = document.getElementById("leverage").value || "Not calculated";
            const risk = document.getElementById("risk").value || "Not specified";
            const position = document.getElementById("longBtn").classList.contains("active") ? "Long" : "Short";
            const slValue = document.getElementById("slValue").textContent;
            const slPrice = document.getElementById("slPrice").textContent;
            const profitValue = document.getElementById("profitValue").textContent;
            const profitValueInr = document.getElementById("profitValueInr").textContent;
            const rrRatio = document.getElementById("rrRatio").textContent;
            const makerFee = document.getElementById("makerFee").textContent;
            const takerFee = document.getElementById("takerFee").textContent;

            const summary = `Trade Summary:
Asset: ${assetName}
Position: ${position}
Entry Price: $${entry}
Position Size: $${leverage}
Risk: $${risk}
Stop Loss Value: ${slValue}
Stop Loss Price: ${slPrice}
Potential Profit: ${profitValue} (${profitValueInr})
Risk/Reward Ratio: ${rrRatio}
Maker Fee: ${makerFee}
Taker Fee: ${takerFee}`;

            alert(summary);
        }

        // Enhanced Notification System
        function showNotification(message, type = 'success') {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;

                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                notification.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-text">
                            <i class="${icons[type]}"></i> ${message}
                        </div>
                        <button class="notification-close" onclick="this.closest('.notification').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                document.body.appendChild(notification);

                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                // Hide notification after 4 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }, 4000);

            } catch (error) {
                console.error("Error showing notification:", error);
            }
        }

        // Handle updating pending trades
        function updateTradeOutcome(tradeId) {
            const trades = loadUserData('trades') || [];
            const trade = trades.find(t => t.id === tradeId);

            if (!trade) return;

            const outcome = prompt("Enter outcome (win/loss):");
            if (!outcome || !['win', 'loss'].includes(outcome.toLowerCase())) {
                showNotification("Invalid outcome. Please enter 'win' or 'loss'.", "error");
                return;
            }

            const exitPrice = parseFloat(prompt("Enter exit price:"));
            if (!exitPrice || exitPrice <= 0) {
                showNotification("Invalid exit price.", "error");
                return;
            }

            const feeType = prompt("Enter fee type (maker/taker):") || 'taker';
            if (!['maker', 'taker'].includes(feeType.toLowerCase())) {
                showNotification("Invalid fee type. Using taker fee.", "warning");
                feeType = 'taker';
            }

            // Calculate profit/loss
            const entry = trade.entry;
            const originalAmount = trade.originalAmount;
            const leverageX = trade.leverageX;
            const isLong = trade.position === 'Long';

            const priceDiff = isLong ? (exitPrice - entry) : (entry - exitPrice);
            const percentageChange = priceDiff / entry;
            let profit = originalAmount * percentageChange * leverageX;

            // Subtract selected fee
            const usedFee = feeType.toLowerCase() === 'maker' ? trade.makerFee : trade.takerFee;
            profit -= usedFee;

            if (outcome.toLowerCase() === 'loss' && profit > 0) {
                profit = -Math.abs(profit);
            }
            if (outcome.toLowerCase() === 'win' && profit < 0) {
                profit = Math.abs(profit);
            }

            // Update trade
            trade.outcome = outcome.toLowerCase();
            trade.profit = profit;
            trade.exitPrice = exitPrice;
            trade.feeType = feeType.toLowerCase();
            trade.usedFee = usedFee;

            // Save updated trades
            if (saveUserData('trades', trades)) {
                updateTotalPL(profit);
                loadTrades();
                updatePerformanceAnalytics();
                updateAdvancedAnalytics();
                showNotification("Trade outcome updated successfully!", "success");
            }
        }

        // Avatar Upload Functions
        function openAvatarModal() {
            // Reset avatar selection
            selectedAvatar = null;
            uploadedImage = null;
            document.getElementById('avatarPreview').style.display = 'none';
            document.getElementById('avatarModal').style.display = 'flex';
        }

        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
        }

        function selectDefaultAvatar(avatarId) {
            selectedAvatar = avatarId;

            // Highlight selected avatar
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Hide preview if showing
            document.getElementById('avatarPreview').style.display = 'none';
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];

            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image file (JPEG, PNG, GIF)', 'error');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('File size exceeds 5MB limit', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // Display preview
                const preview = document.getElementById('avatarPreview');
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.style.display = 'block';

                // Save uploaded image
                uploadedImage = e.target.result;

                // Clear any default avatar selection
                document.querySelectorAll('.avatar-option').forEach(option => {
                    option.classList.remove('selected');
                });
            }

            reader.readAsDataURL(file);
        }

        function saveAvatar() {
            let avatarData = null;

            if (uploadedImage) {
                avatarData = uploadedImage;
            } else if (selectedAvatar) {
                // Get the SVG data for the selected avatar
                switch (selectedAvatar) {
                    case 'default1':
                        avatarData = 'data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%232962ff%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>';
                        break;
                    case 'default2':
                        avatarData = 'data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%23ff6d00%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>';
                        break;
                    case 'default3':
                        avatarData = 'data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect width=%27100%27 height=%27100%27 fill=%27%2300c853%27/><circle cx=%2750%27 cy=%2740%27 r=%2720%27 fill=%27%23fff%27/><path d=%27M20,85 L80,85 C65,70 35,70 20,85 Z%27 fill=%27%23fff%27/></svg>';
                        break;
                }
            }

            if (!avatarData) {
                showNotification('Please select an avatar or upload an image', 'error');
                return;
            }

            // Update current user avatar
            if (currentUser) {
                currentUser.avatar = avatarData;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // Update avatar in header
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = '';
                avatar.style.backgroundImage = `url(${avatarData})`;

                // Update registered user's avatar to persist after logout
                const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
                const userIndex = users.findIndex(u => u.username === currentUser.username);
                if (userIndex !== -1) {
                    users[userIndex].avatar = avatarData;
                    localStorage.setItem('registeredUsers', JSON.stringify(users));
                }

                showNotification('Profile picture updated successfully!', 'success');
                closeAvatarModal();
            }
        }

        // Load saved risk settings on initialization
        function loadRiskSettings() {
            const riskSettings = loadUserData('riskSettings');
            if (riskSettings) {
                document.getElementById('riskAccountBalance').value = riskSettings.accountBalance || 1000;
                document.getElementById('riskPerTradePercent').value = riskSettings.riskPerTradePercent || 2;
                document.getElementById('dailyRiskPercent').value = riskSettings.dailyRiskPercent || 5;
                document.getElementById('maxDrawdownLimit').value = riskSettings.maxDrawdownLimit || 15;
                updateRiskMetrics();
            }
        }

        // Initialize risk settings when app loads
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(loadRiskSettings, 1000); // Load after main initialization
        });
    </script>
</body>

</html>